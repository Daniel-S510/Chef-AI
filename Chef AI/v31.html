<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chef AI - AI Recipe Generator</title>
    <!-- Tailwind CSS for utility-first styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts for custom typography -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Playfair+Display:wght@700&display=swap" rel="stylesheet">
    <!-- Font Awesome for icons (thumbs up/down) -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        /* Base font for the body */
        body {
            font-family: 'Inter', sans-serif;
        }
        /* Special font for titles */
        .title-font {
            font-family: 'Playfair Display', serif;
        }
        /* Styling for the generated recipe content for better readability */
        #recipeResult h2 {
            font-size: 1.5rem;
            font-weight: 700;
            margin-bottom: 1rem;
            color: #1a202c; /* Dark gray */
        }
        #recipeResult h3 {
            font-size: 1.25rem;
            font-weight: 600;
            margin-top: 1.5rem;
            margin-bottom: 0.75rem;
            color: #2d3748; /* Slightly lighter dark gray */
            border-bottom: 2px solid #e2e8f0; /* Light border */
            padding-bottom: 0.25rem;
        }
        #recipeResult ul, #recipeResult ol {
            margin-left: 1.5rem;
            margin-bottom: 1rem;
            list-style-position: outside; /* Ensure bullets/numbers are outside content */
        }
        #recipeResult ul {
            list-style-type: disc; /* Default bullet style */
        }
        #recipeResult ol {
            list-style-type: decimal; /* Default numbered list style */
        }
        #recipeResult li {
            margin-bottom: 0.5rem;
            line-height: 1.6; /* Enhance readability for list items */
        }
        #recipeResult p {
            margin-bottom: 1rem;
            line-height: 1.6; /* Enhance readability for paragraphs */
        }
        /* Custom scrollbar for a polished look */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #f1f1f1; /* Light track */
        }
        ::-webkit-scrollbar-thumb {
            background: #888; /* Gray thumb */
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #555; /* Darker gray on hover */
        }
        /* Styles for the custom message box (success, error, info) */
        .message-box {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            padding: 12px 24px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            z-index: 1000;
            display: none; /* Hidden by default */
            text-align: center;
        }
        .message-box.success {
            background-color: #d4edda; /* Light green */
            color: #155724; /* Dark green */
            border: 1px solid #c3e6cb;
        }
        .message-box.error {
            background-color: #f8d7da; /* Light red */
            color: #721c24; /* Dark red */
            border: 1px solid #f5c6cb;
        }
        .message-box.info {
            background-color: #cce5ff; /* Light blue */
            color: #004085; /* Dark blue */
            border: 1px solid #b8daff;
        }
        /* Spinner animation for buttons */
        .spinner {
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: #fff;
            animation: spin 1s ease-in-out infinite;
            -webkit-animation: spin 1s ease-in-out infinite;
            width: 16px;
            height: 16px;
            display: inline-block;
            vertical-align: middle;
            margin-right: 8px;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        /* Styling for convertible measurements and temperatures to make them clickable */
        .measurement-unit {
            background-color: #e0f2fe; /* Light blue background */
            padding: 2px 5px;
            border-radius: 4px;
            cursor: pointer;
            font-weight: 500;
            color: #0d6efd; /* Darker blue text */
            transition: background-color 0.2s ease-in-out;
            position: relative; /* Essential for popover positioning */
        }
        .measurement-unit:hover {
            background-color: #bae6fd; /* Slightly darker on hover */
        }
        /* Popover styles for unit/temperature conversion */
        #conversionPopover {
            min-width: 150px;
            max-width: 250px;
            font-size: 0.9rem;
            position: absolute;
            background-color: #ffffff;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            padding: 1rem;
            z-index: 1000;
        }
        #conversionPopover ul {
            list-style: none;
            padding: 0;
            margin: 0;
        }
        #conversionPopover li {
            padding: 0.25rem 0;
            border-bottom: 1px solid #f1f1f1;
        }
        #conversionPopover li:last-child {
            border-bottom: none;
        }
        #conversionPopover .close-button {
            position: absolute;
            top: 0.5rem;
            right: 0.5rem;
            background: none;
            border: none;
            cursor: pointer;
            color: #a0aec0; /* Light gray for close button */
        }
        #conversionPopover .close-button:hover {
            color: #4a5568; /* Darker gray on hover */
        }
        /* Hover styles for action buttons */
        .bookmark-btn:hover {
            color: #3b82f6; /* Blue-500 */
            background-color: #eff6ff; /* Blue-50 */
        }
        .download-btn:hover {
            color: #22c55e; /* Green-500 */
            background-color: #f0fdf4; /* Green-50 */
        }
        .share-btn:hover {
            color: #6366f1; /* Indigo-500 */
            background-color: #eef2ff; /* Indigo-50 */
        }
        /* Styles for persistent API error message */
        .api-error-message {
            background-color: #fef2f2; /* Red-50 */
            color: #ef4444; /* Red-500 */
            border: 1px solid #ef4444; /* Red-500 */
            padding: 1rem;
            border-radius: 0.5rem;
            margin-top: 1rem;
            text-align: left;
        }
        .api-error-message h3 {
            font-size: 1.25rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
            color: #b91c1c; /* Red-700 */
        }
        .api-error-message p {
            font-size: 1rem;
            margin-bottom: 0.5rem;
        }

        /* Styles for past recipes tabs */
        .tab-button {
            padding: 0.75rem 1.25rem;
            border-bottom: 3px solid transparent;
            font-weight: 600;
            color: #6b7280; /* Gray-500 */
            transition: all 0.2s ease-in-out;
        }
        .tab-button:hover {
            color: #4b5563; /* Gray-700 */
        }
        .tab-button.active {
            color: #4338ca; /* Indigo-700 */
            border-color: #4338ca; /* Indigo-700 */
        }

        /* Custom styles for the mode toggle in the header */
        #modeToggleContainer {
            display: flex;
            background-color: #e2e8f0; /* Gray-200 */
            border-radius: 9999px; /* Fully rounded */
            padding: 4px;
            box-shadow: inset 0 1px 3px 0 rgba(0, 0, 0, 0.1), inset 0 1px 2px 0 rgba(0, 0, 0, 0.06);
            position: relative; /* For the slider effect */
        }
        #modeToggleContainer label {
            position: relative;
            z-index: 10; /* Above the slider */
            flex: 1;
            text-align: center;
            padding: 0.5rem 1rem;
            border-radius: 9999px;
            cursor: pointer;
            font-weight: 600;
            color: #4a5568; /* Gray-700 */
            transition: color 0.3s ease;
        }
        #modeToggleContainer input[type="radio"] {
            display: none; /* Hide native radio button */
        }
        /* Slider for the active state */
        #modeSlider {
            position: absolute;
            top: 4px;
            left: 4px;
            height: calc(100% - 8px);
            width: calc(50% - 4px); /* Half width for initial state */
            background-color: #ffffff;
            border-radius: 9999px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
            transition: transform 0.3s ease;
            z-index: 5;
        }
        #modeToggleContainer input[id="mode-toggle-baking"]:checked ~ #modeSlider {
            transform: translateX(100%);
        }
        #modeToggleContainer input[id="mode-toggle-cooking"]:checked ~ #modeSlider {
            transform: translateX(0%);
        }
        /* Text color when selected */
        #modeToggleContainer input[id="mode-toggle-cooking"]:checked + label {
            color: #4338ca; /* Indigo-700 */
        }
        #modeToggleContainer input[id="mode-toggle-baking"]:checked + label {
            color: #4338ca; /* Indigo-700 */
        }
        /* Styles for ingredient suggestions popover */
        #ingredientSuggestionsPopover {
            min-width: 200px;
            max-width: 350px;
            font-size: 0.9rem;
            position: absolute;
            background-color: #ffffff;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            padding: 1rem;
            z-index: 1000;
        }
        #ingredientSuggestionsPopover ul {
            list-style: none;
            padding: 0;
            margin: 0;
        }
        #ingredientSuggestionsPopover li {
            padding: 0.25rem 0;
            border-bottom: 1px solid #f1f1f1;
            cursor: pointer;
            transition: background-color 0.1s ease;
        }
        #ingredientSuggestionsPopover li:hover {
            background-color: #f8fafc;
        }
        #ingredientSuggestionsPopover li:last-child {
            border-bottom: none;
        }
        #ingredientSuggestionsPopover .close-button {
            position: absolute;
            top: 0.5rem;
            right: 0.5rem;
            background: none;
            border: none;
            cursor: pointer;
            color: #a0aec0; /* Light gray for close button */
        }
        #ingredientSuggestionsPopover .close-button:hover {
            color: #4a5568; /* Darker gray on hover */
        }

        /* Rating button styles */
        .rating-btn {
            @apply p-2 rounded-full text-gray-400 hover:bg-gray-100 transition-colors duration-200;
        }
        .rating-btn.active-thumb-up {
            @apply text-green-500 bg-green-50;
        }
        .rating-btn.active-thumb-down {
            @apply text-red-500 bg-red-50;
        }
    </style>
</head>
<body class="bg-gray-50 text-gray-800">

    <!-- Global Message Box for alerts and notifications -->
    <div id="messageBox" class="message-box"></div>

    <!-- Settings Modal: Hidden by default, shown when user clicks settings icon -->
    <div id="settingsModal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden flex items-center justify-center p-4">
        <div class="bg-white rounded-lg shadow-xl p-6 md:p-8 w-11/12 md:w-1/3 max-w-lg">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-2xl font-bold text-gray-900">Settings</h2>
                <!-- Close button for the modal -->
                <button id="closeModal" class="text-gray-500 hover:text-gray-800 focus:outline-none focus:ring-2 focus:ring-gray-300 rounded-full">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                </button>
            </div>
            <!-- API Key input field -->
            <div class="mb-4">
                <label for="apiKey" class="block text-sm font-medium text-gray-700 mb-2">Gemini API Key</label>
                <input type="password" id="apiKey" name="apiKey" class="w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500" placeholder="Enter your API key">
                <p class="text-xs text-gray-500 mt-2">Your API key is used to generate recipes with AI.</p>
            </div>
            <!-- Measurement System preference (Imperial/Metric) -->
            <div class="mb-6">
                <label class="block text-sm font-medium text-gray-700">Default Measurement System</label>
                <div class="mt-2 space-y-2">
                    <div class="flex items-center">
                        <input id="measure-imperial" name="defaultMeasurement" type="radio" value="imperial" class="focus:ring-indigo-500 h-4 w-4 text-indigo-600 border-gray-300">
                        <label for="measure-imperial" class="ml-3 block text-sm font-medium text-gray-700">Imperial (e.g., cups, ounces)</label>
                    </div>
                    <div class="flex items-center">
                        <input id="measure-metric" name="defaultMeasurement" type="radio" value="metric" class="focus:ring-indigo-500 h-4 w-4 text-indigo-600 border-gray-300">
                        <label for="measure-metric" class="ml-3 block text-sm font-medium text-gray-700">Metric (e.g., milliliters, grams)</label>
                    </div>
                </div>
            </div>
            <!-- Remember API Key checkbox -->
            <div class="flex items-center mb-6">
                <input id="rememberApiKey" name="rememberApiKey" type="checkbox" class="focus:ring-indigo-500 h-4 w-4 text-indigo-600 border-gray-300 rounded">
                <label for="rememberApiKey" class="ml-2 block text-sm font-medium text-gray-700">Remember API Key (stores in browser)</label>
            </div>
            <!-- Save Settings button -->
            <div class="mt-6 flex justify-end">
                <button id="saveSettings" class="bg-indigo-600 text-white px-4 py-2 rounded-lg hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">Save</button>
            </div>
        </div>
    </div>

    <!-- Confirmation Modal for Clear All Recipes (used for both desktop and mobile "Clear All" buttons) -->
    <div id="clearConfirmModal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden flex items-center justify-center p-4">
        <div class="bg-white rounded-lg shadow-xl p-6 md:p-8 w-11/12 md:w-1/3 max-w-lg">
            <h2 id="clearConfirmTitle" class="text-xl font-bold mb-4 text-gray-900"></h2>
            <p id="clearConfirmMessage" class="text-gray-700 mb-6"></p>
            <div class="flex justify-end space-x-4">
                <button id="cancelClear" class="px-4 py-2 bg-gray-200 text-gray-800 rounded-lg hover:bg-gray-300 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gray-400">Cancel</button>
                <button id="confirmClear" class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500"></button>
            </div>
        </div>
    </div>

    <!-- Past Recipes Full-Screen Modal (for mobile viewports) -->
    <div id="pastRecipesFullModal" class="fixed inset-0 bg-white z-40 hidden flex flex-col">
        <header class="flex justify-between items-center p-4 border-b border-gray-200">
            <h2 class="text-2xl font-bold text-gray-900">Past Recipes</h2>
            <!-- Close button for the mobile past recipes modal -->
            <button id="closePastRecipesModal" class="text-gray-500 hover:text-gray-800 p-2 rounded-full hover:bg-gray-200 transition-colors focus:outline-none focus:ring-2 focus:ring-gray-300">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
            </button>
        </header>
        <div class="p-4 flex-grow overflow-y-auto">
            <div class="bg-white rounded-lg shadow-md mb-8">
                <!-- Tab Navigation for Mobile Past Recipes -->
                <div class="flex border-b border-gray-200 mb-4">
                    <button id="cookingTabBtnMobile" class="tab-button active flex-1 text-center">Cooking</button>
                    <button id="bakingTabBtnMobile" class="tab-button flex-1 text-center">Baking</button>
                </div>
                <!-- Clear All button specific to mobile modal -->
                <div class="flex justify-end items-center mb-4">
                    <button id="clearAllRecipesBtnMobile" class="px-4 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500 transition-colors text-sm">
                        Clear All Unbookmarked
                    </button>
                </div>
                <!-- Mobile Cooking Recipes List -->
                <ul id="pastCookingRecipesListMobile" class="space-y-2">
                    <li id="noPastCookingRecipesMobile" class="text-gray-500 text-center py-4">No cooking recipes yet. Generate one to see it here!</li>
                </ul>
                <!-- Mobile Baking Recipes List (Hidden by default) -->
                <ul id="pastBakingRecipesListMobile" class="space-y-2 hidden">
                    <li id="noPastBakingRecipesMobile" class="text-gray-500 text-center py-4">No baking recipes yet. Generate one to see it here!</li>
                </ul>
            </div>
        </div>
    </div>

    <!-- Main Container for the entire application layout -->
    <div class="container mx-auto p-4 md:p-8">
        <!-- Header Section -->
        <header class="flex flex-col items-center mb-8 lg:flex-row lg:justify-between lg:items-center">
            <!-- Button to open past recipes modal on mobile screens (hidden on large screens) -->
            <button id="openPastRecipesMobileBtn" class="text-gray-600 hover:text-gray-900 p-2 rounded-full hover:bg-gray-200 transition-colors block lg:hidden focus:outline-none focus:ring-2 focus:ring-gray-300 self-start">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path></svg>
            </button>
            <h1 class="text-4xl md:text-5xl title-font text-gray-900 flex-grow text-center lg:text-left">Chef AI</h1>
            
            <!-- Mode Toggle (Cooking/Baking) - Positioned for mobile below title, and next to title on desktop -->
            <div id="modeToggleContainer" class="mt-4 md:mt-0 md:ml-auto md:mr-4 flex items-center">
                <input type="radio" id="mode-toggle-cooking" name="modeToggle" value="cooking" checked>
                <label for="mode-toggle-cooking">Cooking</label>
                <input type="radio" id="mode-toggle-baking" name="modeToggle" value="baking">
                <label for="mode-toggle-baking">Baking</label>
                <div id="modeSlider"></div>
            </div>

            <!-- Settings button (ellipsis icon) -->
            <button id="openSettings" class="text-gray-600 hover:text-gray-900 p-2 rounded-full hover:bg-gray-200 transition-colors focus:outline-none focus:ring-2 focus:ring-gray-300 self-end lg:self-center">
                <svg class="w-6 h-6 md:w-7 md:h-7" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 12h.01M12 12h.01M19 12h.01"></path>
                </svg>
            </button>
        </header>

        <main class="grid grid-cols-1 lg:grid-cols-12 gap-8">
            <!-- Recipe Result Section: Displays the AI-generated recipe -->
            <!-- On larger screens, this section takes 8/12 columns and is on the right (order-2) -->
            <div id="recipeResultContainer" class="lg:col-span-8 order-1 lg:order-2">
                <div class="bg-white p-6 md:p-8 rounded-lg shadow-md min-h-[400px] mb-8 relative flex flex-col justify-center items-center">
                    <!-- Action buttons for the currently displayed recipe -->
                    <div id="recipeActions" class="absolute top-4 right-4 flex space-x-2 hidden">
                        <button id="bookmarkCurrentRecipeBtn" class="flex-shrink-0 text-gray-500 hover:text-blue-700 p-1 rounded-full bookmark-btn transition-colors focus:outline-none focus:ring-2 focus:ring-blue-300" title="Bookmark Recipe">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 5a2 2 0 012-2h10a2 2 0 012 2v16l-7-3.5L5 21V5z"></path></svg>
                        </button>
                        <button id="shareCurrentRecipeBtn" class="flex-shrink-0 text-gray-500 hover:text-indigo-700 p-1 rounded-full share-btn transition-colors focus:outline-none focus:ring-2 focus:ring-indigo-300" title="Share Recipe">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.684 13.342C8.886 12.938 9 12.482 9 12c0-.478-.114-.933-.316-1.342m0 2.684a3 3 0 110-2.684m0 2.684l6.632 3.316m-6.632-6l6.632-3.316m0 0a3 3 0 105.367-2.684 3 3 0 00-5.367 2.684zm0 9.316a3 3 0 105.367 2.684 3 3 0 00-5.367-2.684z"></path></svg>
                        </button>
                        <button id="downloadCurrentRecipeBtn" class="flex-shrink-0 text-gray-500 hover:text-green-700 p-1 rounded-full download-btn transition-colors focus:outline-none focus:ring-2 focus:ring-green-300" title="Download Recipe">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path></svg>
                        </button>
                         <button id="copyCurrentRecipeBtn" class="flex-shrink-0 text-gray-500 hover:text-purple-700 p-1 rounded-full download-btn transition-colors focus:outline-none focus:ring-2 focus:ring-purple-300" title="Copy to Clipboard">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 5H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-2M8 5a2 2 0 002 2h2a2 2 0 002-2M8 5a2 2 0 012-2h2a2 2 0 012 2m0 0h2.586a1 1 0 01.707 1.707l-4.586 4.586a1 1 0 01-1.707-.707V10m0 0h4"></path></svg>
                        </button>
                    </div>

                    <!-- Initial State: Shown before any recipe is generated -->
                    <div id="initialState" class="text-center flex flex-col justify-center items-center h-full">
                        <svg class="w-20 h-20 text-gray-300 mb-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1" d="M9 13h6" />
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1" d="M12 10v6" />
                        </svg>
                        <h3 class="text-xl font-semibold text-gray-700">Your recipe will appear here</h3>
                        <p class="text-gray-500 mt-2">Fill out the form and click "Generate Recipe" to get started.</p>
                    </div>
                    <!-- Loading State: Shown while AI is generating the recipe -->
                    <div id="loadingState" class="text-center hidden flex-col justify-center items-center h-full">
                        <div class="animate-spin rounded-full h-16 w-16 border-t-2 border-b-2 border-indigo-500"></div>
                        <p class="mt-4 text-gray-600 font-medium">Chef AI is thinking...</p>
                    </div>
                    <!-- Recipe Content Area: Where the generated HTML recipe is injected -->
                    <div id="recipeResult" class="prose max-w-none w-full text-left"></div>

                    <!-- Recipe Rating Buttons -->
                    <div id="ratingControls" class="flex justify-center space-x-4 mt-4 pt-4 border-t border-gray-200 w-full hidden">
                        <button id="thumbUpBtn" class="rating-btn" title="Like this recipe">
                            <i class="fas fa-thumbs-up text-2xl"></i>
                        </button>
                        <button id="thumbDownBtn" class="rating-btn" title="Dislike this recipe">
                            <i class="fas fa-thumbs-down text-2xl"></i>
                        </button>
                    </div>
                </div>

                <!-- Past Recipes Section (Desktop View): Hidden on mobile, shown on desktop -->
                <div id="pastRecipesContainer" class="hidden lg:block bg-white p-6 md:p-8 rounded-lg shadow-md">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-2xl font-bold text-gray-900">Past Recipes</h2>
                        <!-- Clear All button specific to desktop past recipes section -->
                        <button id="clearAllRecipesBtnDesktop" class="px-4 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500 transition-colors text-sm">
                            Clear All Unbookmarked
                        </button>
                    </div>
                    <!-- Tab Navigation for Desktop Past Recipes -->
                    <div class="flex border-b border-gray-200 mb-4">
                        <button id="cookingTabBtnDesktop" class="tab-button active flex-1 text-center">Cooking</button>
                        <button id="bakingTabBtnDesktop" class="tab-button flex-1 text-center">Baking</button>
                    </div>
                    <!-- Desktop Cooking Recipes List -->
                    <ul id="pastCookingRecipesListDesktop" class="space-y-2">
                        <li id="noPastCookingRecipesDesktop" class="text-gray-500 text-center py-4">No cooking recipes yet. Generate one to see it here!</li>
                    </ul>
                    <!-- Desktop Baking Recipes List (Hidden by default) -->
                    <ul id="pastBakingRecipesListDesktop" class="space-y-2 hidden">
                        <li id="noPastBakingRecipesDesktop" class="text-gray-500 text-center py-4">No baking recipes yet. Generate one to see it here!</li>
                    </ul>
                </div>
            </div>

            <!-- Form Section: User inputs for recipe generation -->
            <!-- On larger screens, this section takes 4/12 columns and is on the left (order-1) -->
            <div class="lg:col-span-4 order-2 lg:order-1">
                <div class="bg-white p-6 rounded-lg shadow-md">
                    <h2 class="text-2xl font-bold mb-6 text-gray-900">Create Your Recipe</h2>
                    <form id="recipeForm" class="space-y-6">
                        <!-- Submit and Clear Buttons at the top of the form for quick access -->
                        <div class="flex flex-col space-y-4">
                            <button type="submit" id="generateRecipeBtn" class="w-full bg-indigo-600 text-white py-3 px-4 border border-transparent rounded-lg shadow-sm text-base font-medium hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition-all duration-200 ease-in-out transform hover:scale-105">
                                <span id="buttonText">Generate Recipe</span>
                                <span id="buttonSpinner" class="spinner hidden"></span>
                            </button>
                            <button type="button" id="clearFormBtn" class="w-full bg-gray-200 text-gray-800 py-3 px-4 border border-transparent rounded-lg shadow-sm text-base font-medium hover:bg-gray-300 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gray-400 transition-all duration-200 ease-in-out">
                                Clear Form
                            </button>
                        </div>
                        
                        <!-- Custom Instructions Textarea -->
                        <div>
                            <label for="customInstructions" class="block text-sm font-medium text-gray-700">Custom Instructions</label>
                            <textarea id="customInstructions" name="customInstructions" rows="3" class="mt-1 block w-full shadow-sm sm:text-sm border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 resize-y" placeholder="e.g., Make it spicy, use minimal oil, family-friendly"></textarea>
                        </div>

                        <!-- Theme/Cuisine Dropdown -->
                        <div>
                            <label for="theme" class="block text-sm font-medium text-gray-700">Theme / Cuisine</label>
                            <select id="theme" name="theme" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm rounded-lg">
                                <option>Any</option>
                                <option>Italian</option>
                                <option>Mexican</option>
                                <option>Japanese</option>
                                <option>Indian</option>
                                <option>Chinese</option>
                                <option>French</option>
                                <option>Mediterranean</option>
                                <option>American</option>
                            </select>
                        </div>

                        <!-- New Baking Type Dropdown (conditionally visible) -->
                        <div id="bakingTypeContainer" class="hidden">
                            <label for="bakingType" class="block text-sm font-medium text-gray-700">Baking Type</label>
                            <select id="bakingType" name="bakingType" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm rounded-lg">
                                <option value="">Any Baking Type</option>
                                <option value="Cake">Cake</option>
                                <option value="Cookies">Cookies</option>
                                <option value="Bread">Bread</option>
                                <option value="Pastry">Pastry</option>
                                <option value="Pie">Pie</option>
                                <option value="Muffin/Cupcake">Muffin/Cupcake</option>
                                <option value="Brownie/Bar">Brownie/Bar</option>
                                <option value="Dessert">General Dessert</option>
                            </select>
                        </div>
                        
                        <!-- Ingredients Textarea with "Only use these ingredients" checkbox -->
                        <div>
                            <label for="ingredients" class="block text-sm font-medium text-gray-700">Available Ingredients</label>
                            <textarea id="ingredients" name="ingredients" rows="4" class="mt-1 block w-full shadow-sm sm:text-sm border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 resize-y" placeholder="e.g., chicken breast, rice, broccoli, soy sauce"></textarea>
                            <div class="mt-2 flex items-center">
                                <input id="onlyTheseIngredients" name="onlyTheseIngredients" type="checkbox" class="focus:ring-indigo-500 h-4 w-4 text-indigo-600 border-gray-300 rounded">
                                <label for="onlyTheseIngredients" class="ml-2 block text-sm font-medium text-gray-700">Only use these ingredients</label>
                            </div>
                            <button type="button" id="getSuggestionsBtn" class="mt-3 w-full bg-blue-500 text-white py-2 px-4 border border-transparent rounded-lg shadow-sm text-sm font-medium hover:bg-blue-600 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-400 transition-all duration-200 ease-in-out">
                                <span id="suggestionsButtonText">Get Ingredient Suggestions</span>
                                <span id="suggestionsButtonSpinner" class="spinner hidden"></span>
                            </button>
                        </div>

                        <!-- Max Cooking Time Dropdown - Label and options will change dynamically -->
                        <div>
                             <label id="cookingTimeLabel" for="cookingTime" class="block text-sm font-medium text-gray-700">Max Cooking Time</label>
                            <select id="cookingTime" name="cookingTime" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm rounded-lg">
                                <option value="15 minutes">Under 15 minutes</option>
                                <option value="30 minutes" selected>30 minutes</option>
                                <option value="1 hour">1 hour</option>
                                <option value="more than 1 hour">1 hour+</option>
                            </select>
                        </div>

                        <!-- Dish Size Radio Buttons -->
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Dish Size (General)</label>
                            <div class="mt-2 space-y-2">
                                <div class="flex items-center">
                                    <input id="size-snack" name="dishSizeOption" type="radio" value="Snack" class="focus:ring-indigo-500 h-4 w-4 text-indigo-600 border-gray-300">
                                    <label for="size-snack" class="ml-3 block text-sm font-medium text-gray-700">Snack</label>
                                </div>
                                <div class="flex items-center">
                                    <input id="size-single" name="dishSizeOption" type="radio" value="Single Serving" checked class="focus:ring-indigo-500 h-4 w-4 text-indigo-600 border-gray-300">
                                    <label for="size-single" class="ml-3 block text-sm font-medium text-gray-700">Single Serving</label>
                                </div>
                                <div class="flex items-center">
                                    <input id="size-family" name="dishSizeOption" type="radio" value="Family Meal (4 servings)" class="focus:ring-indigo-500 h-4 w-4 text-indigo-600 border-gray-300">
                                    <label for="size-family" class="ml-3 block text-sm font-medium text-gray-700">Family Meal</label>
                                </div>
                            </div>
                        </div>

                        <!-- Number of Servings Numeric Input with +/- buttons -->
                        <div>
                            <label for="servings" class="block text-sm font-medium text-gray-700">Number of Servings (Exact)</label>
                            <div class="mt-1 flex rounded-lg shadow-sm">
                                <button type="button" id="decreaseServings" class="inline-flex items-center p-2 border border-r-0 border-gray-300 bg-gray-50 text-sm text-gray-500 rounded-l-lg hover:bg-gray-100 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">
                                    <svg class="h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 12H4"></path></svg>
                                </button>
                                <input type="number" id="servings" name="servings" value="1" min="1" class="focus:ring-indigo-500 focus:border-indigo-500 flex-1 block w-full rounded-none sm:text-sm border-gray-300 p-2 text-center" aria-label="Number of servings">
                                <button type="button" id="increaseServings" class="inline-flex items-center p-2 border border-l-0 border-gray-300 bg-gray-50 text-sm text-gray-500 rounded-r-lg hover:bg-gray-100 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">
                                    <svg class="h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path></svg>
                                </button>
                            </div>
                        </div>

                        <!-- Dietary Restrictions Checkboxes -->
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Dietary Needs</label>
                            <div class="mt-2 space-y-2">
                                <div class="flex items-center">
                                    <input id="diet-vegetarian" name="diet" type="checkbox" value="Vegetarian" class="focus:ring-indigo-500 h-4 w-4 text-indigo-600 border-gray-300 rounded">
                                    <label for="diet-vegetarian" class="ml-3 block text-sm font-medium text-gray-700">Vegetarian</label>
                                </div>
                                <div class="flex items-center">
                                    <input id="diet-vegan" name="diet" type="checkbox" value="Vegan" class="focus:ring-indigo-500 h-4 w-4 text-indigo-600 border-gray-300">
                                    <label for="diet-vegan" class="ml-3 block text-sm font-medium text-gray-700">Vegan</label>
                                </div>
                                <div class="flex items-center">
                                    <input id="diet-glutenfree" name="diet" type="checkbox" value="Gluten-Free" class="focus:ring-indigo-500 h-4 w-4 text-indigo-600 border-gray-300 rounded">
                                    <label for="diet-glutenfree" class="ml-3 block text-sm font-medium text-gray-700">Gluten-Free</label>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </main>
    </div>

    <!-- Conversion Popover: Hidden by default, appears when clicking on measurements/temperatures -->
    <div id="conversionPopover" class="hidden">
        <button id="closePopover" class="close-button">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
        </button>
        <div id="popoverContent"></div>
    </div>

    <!-- Ingredient Suggestions Popover: Hidden by default -->
    <div id="ingredientSuggestionsPopover" class="hidden">
        <button id="closeSuggestionsPopover" class="close-button">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
        </button>
        <h3 class="text-lg font-semibold mb-2 text-gray-800">Suggestions:</h3>
        <ul id="suggestionsList" class="space-y-1"></ul>
        <p id="noSuggestionsMessage" class="text-gray-500 text-sm italic mt-2 hidden">No suggestions found. Try different initial ingredients.</p>
    </div>


    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- DOM Element References ---
            // Modals
            const settingsModal = document.getElementById('settingsModal');
            const openSettingsBtn = document.getElementById('openSettings');
            const closeSettingsBtn = document.getElementById('closeModal');
            const saveSettingsBtn = document.getElementById('saveSettings');
            const apiKeyInput = document.getElementById('apiKey');
            const rememberApiKeyCheckbox = document.getElementById('rememberApiKey');
            const measureImperialRadio = document.getElementById('measure-imperial');
            const measureMetricRadio = document.getElementById('measure-metric');

            // Confirmation Modal
            const clearConfirmModal = document.getElementById('clearConfirmModal');
            const confirmClearBtn = document.getElementById('confirmClear');
            const cancelClearBtn = document.getElementById('cancelClear');
            const clearConfirmTitle = document.getElementById('clearConfirmTitle');
            const clearConfirmMessage = document.getElementById('clearConfirmMessage');

            // Past Recipes Mobile Modal
            const pastRecipesFullModal = document.getElementById('pastRecipesFullModal');
            const openPastRecipesMobileBtn = document.getElementById('openPastRecipesMobileBtn');
            const closePastRecipesModal = document.getElementById('closePastRecipesModal');

            // Form and Result Area
            const recipeForm = document.getElementById('recipeForm');
            const initialState = document.getElementById('initialState');
            const loadingState = document.getElementById('loadingState');
            const recipeResult = document.getElementById('recipeResult');
            const recipeActions = document.getElementById('recipeActions'); // Container for action buttons (bookmark, share, download)
            const ratingControls = document.getElementById('ratingControls'); // Container for rating buttons

            // Past Recipes Lists (desktop and mobile) - Updated for tabs
            const pastCookingRecipesListDesktop = document.getElementById('pastCookingRecipesListDesktop');
            const noPastCookingRecipesDesktopMessage = document.getElementById('noPastCookingRecipesDesktop');
            const pastBakingRecipesListDesktop = document.getElementById('pastBakingRecipesListDesktop');
            const noPastBakingRecipesDesktopMessage = document.getElementById('noPastBakingRecipesDesktop');

            const pastCookingRecipesListMobile = document.getElementById('pastCookingRecipesListMobile');
            const noPastCookingRecipesMobileMessage = document.getElementById('noPastCookingRecipesMobile');
            const pastBakingRecipesListMobile = document.getElementById('pastBakingRecipesListMobile');
            const noPastBakingRecipesMobileMessage = document.getElementById('noPastBakingRecipesMobile');

            const clearAllRecipesBtnDesktop = document.getElementById('clearAllRecipesBtnDesktop');
            const clearAllRecipesBtnMobile = document.getElementById('clearAllRecipesBtnMobile');

            // Mode Toggle Radios (in header)
            const cookingModeToggle = document.getElementById('mode-toggle-cooking');
            const bakingModeToggle = document.getElementById('mode-toggle-baking');
            const modeSlider = document.getElementById('modeSlider');


            // Past Recipes Tab Buttons
            const cookingTabBtnDesktop = document.getElementById('cookingTabBtnDesktop');
            const bakingTabBtnDesktop = document.getElementById('bakingTabBtnDesktop');
            const cookingTabBtnMobile = document.getElementById('cookingTabBtnMobile');
            const bakingTabBtnMobile = document.getElementById('bakingTabBtnMobile');

            // General UI Elements
            const messageBox = document.getElementById('messageBox'); // For custom notification messages
            const generateRecipeBtn = document.getElementById('generateRecipeBtn'); // Main generate button
            const buttonText = document.getElementById('buttonText');
            const buttonSpinner = document.getElementById('buttonSpinner');
            const clearFormBtn = document.getElementById('clearFormBtn'); // Clear form button

            // Servings Input (+/- buttons)
            const servingsInput = document.getElementById('servings');
            const decreaseServingsBtn = document.getElementById('decreaseServings');
            const increaseServingsBtn = document.getElementById('increaseServings');

            // Measurement Conversion Popover
            const conversionPopover = document.getElementById('conversionPopover');
            const popoverContent = document.getElementById('popoverContent');
            const closePopoverBtn = document.getElementById('closePopover');

            // Form-specific checkboxes
            const onlyTheseIngredientsCheckbox = document.getElementById('onlyTheseIngredients');
            const ingredientsTextarea = document.getElementById('ingredients'); // Reference to the ingredients textarea
            const customInstructionsTextarea = document.getElementById('customInstructions'); // Reference to custom instructions textarea


            // Ingredient Suggestions
            const getSuggestionsBtn = document.getElementById('getSuggestionsBtn');
            const suggestionsButtonText = document.getElementById('suggestionsButtonText');
            const suggestionsButtonSpinner = document.getElementById('suggestionsButtonSpinner');
            const ingredientSuggestionsPopover = document.getElementById('ingredientSuggestionsPopover');
            const suggestionsList = document.getElementById('suggestionsList');
            const noSuggestionsMessage = document.getElementById('noSuggestionsMessage');
            const closeSuggestionsPopoverBtn = document.getElementById('closeSuggestionsPopover');


            // Dynamic Form Fields
            const cookingTimeLabel = document.getElementById('cookingTimeLabel');
            const cookingTimeSelect = document.getElementById('cookingTime');
            const bakingTypeContainer = document.getElementById('bakingTypeContainer');
            const bakingTypeSelect = document.getElementById('bakingType');

            // Current Recipe Action Buttons
            const bookmarkCurrentRecipeBtn = document.getElementById('bookmarkCurrentRecipeBtn');
            const shareCurrentRecipeBtn = document.getElementById('shareCurrentRecipeBtn');
            const downloadCurrentRecipeBtn = document.getElementById('downloadCurrentRecipeBtn');
            const copyCurrentRecipeBtn = document.getElementById('copyCurrentRecipeBtn');

            // Rating Buttons
            const thumbUpBtn = document.getElementById('thumbUpBtn');
            const thumbDownBtn = document.getElementById('thumbDownBtn');


            // --- Global State Variables ---
            let geminiApiKey = ''; // Stores API key in memory
            // Stores an array of recipe objects: { id, name, content (raw HTML), isBookmarked, timestamp, mode, rating (null, 'up', 'down') }
            let pastRecipes = []; 
            let defaultMeasurementSystem = 'imperial'; // User's preferred measurement system (imperial/metric)
            let currentRecipeId = null; // ID of the recipe currently displayed in the main result area
            let currentGenerationMode = 'cooking'; // 'cooking' or 'baking' - for the form
            let currentDisplayMode = 'cooking'; // 'cooking' or 'baking' - for the past recipes tabs


            // --- Utility Functions ---

            /**
             * Displays a custom message box at the top of the screen.
             * @param {string} message The message to display.
             * @param {string} type The type of message ('success', 'error', 'info').
             */
            function showMessage(message, type = 'success') {
                messageBox.textContent = message;
                messageBox.className = `message-box ${type}`; // Apply type-specific styling
                messageBox.style.display = 'block'; // Make visible
                // Automatically hide after 3 seconds
                setTimeout(() => {
                    messageBox.style.display = 'none';
                }, 3000); 
            }

            /**
             * Generates a UUID. Uses crypto.randomUUID() if available, falls back to a less secure method.
             * @returns {string} A unique identifier string.
             */
            function generateUUID() {
                if (typeof crypto !== 'undefined' && crypto.randomUUID) {
                    return crypto.randomUUID();
                } else {
                    // Fallback for older browsers or restricted environments
                    return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
                        var r = Math.random() * 16 | 0, v = c == 'x' ? r : (r & 0x3 | 0x8);
                        return v.toString(16);
                    });
                }
            }

            /**
             * Extracts the recipe name from the generated HTML content (assumes h2 is the title).
             * @param {string} htmlContent The full HTML content of the recipe.
             * @returns {string} The extracted recipe name or 'Untitled Recipe' if not found.
             */
            function extractRecipeName(htmlContent) {
                const tempDiv = document.createElement('div');
                tempDiv.innerHTML = htmlContent;
                const h2 = tempDiv.querySelector('h2');
                return h2 ? h2.textContent.trim() : 'Untitled Recipe';
            }

            /**
             * Saves the current `pastRecipes` array to local storage.
             */
            function saveRecipesToLocalStorage() {
                localStorage.setItem('pastRecipes', JSON.stringify(pastRecipes));
                // Also save the current display mode
                localStorage.setItem('currentDisplayMode', currentDisplayMode);
            }

            /**
             * Deletes a recipe from the `pastRecipes` array and local storage.
             * If the deleted recipe was currently displayed, clears the main display.
             * @param {string} idToDelete The ID of the recipe to delete.
             */
            function deleteRecipe(idToDelete) {
                pastRecipes = pastRecipes.filter(recipe => recipe.id !== idToDelete);
                saveRecipesToLocalStorage();
                renderPastRecipes(); // Re-render both desktop and mobile lists for the current display mode
                if (currentRecipeId === idToDelete) { 
                    recipeResult.innerHTML = ''; // Clear main display
                    initialState.classList.remove('hidden'); // Show initial state
                    recipeActions.classList.add('hidden'); // Hide action buttons
                    ratingControls.classList.add('hidden'); // Hide rating buttons
                    // Remove any padding applied to recipeResult if it was showing a recipe
                    recipeResult.classList.remove('pt-16', 'sm:pt-20', 'lg:pt-8');
                    currentRecipeId = null; // Reset current recipe ID
                }
                showMessage('Recipe deleted.', 'success');
            }

            /**
             * Toggles the bookmarked status of a recipe.
             * @param {string} idToToggle The ID of the recipe to toggle.
             */
            function toggleBookmark(idToToggle) {
                const recipeIndex = pastRecipes.findIndex(recipe => recipe.id === idToToggle);
                if (recipeIndex > -1) {
                    pastRecipes[recipeIndex].isBookmarked = !pastRecipes[recipeIndex].isBookmarked;
                    saveRecipesToLocalStorage();
                    // Re-render both lists as bookmarking affects sorting (bookmarked recipes appear first)
                    renderPastRecipes(); 
                    // Update the bookmark button in the main display if this is the current recipe
                    if (currentRecipeId === idToToggle) {
                        updateBookmarkButtonState(pastRecipes[recipeIndex].isBookmarked);
                    }
                    showMessage(pastRecipes[recipeIndex].isBookmarked ? 'Recipe bookmarked!' : 'Recipe unbookmarked.', 'info');
                }
            }

            /**
             * Updates the bookmark button's icon and title based on the bookmark status.
             * @param {boolean} isBookmarked True if the recipe is bookmarked, false otherwise.
             */
            function updateBookmarkButtonState(isBookmarked) {
                bookmarkCurrentRecipeBtn.innerHTML = `<svg class="w-6 h-6" fill="${isBookmarked ? 'currentColor' : 'none'}" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 5a2 2 0 012-2h10a2 2 0 012 2v16l-7-3.5L5 21V5z"></path></svg>`;
                bookmarkCurrentRecipeBtn.title = isBookmarked ? 'Unbookmark Recipe' : 'Bookmark Recipe';
            }

            /**
             * Updates the rating state for a given recipe.
             * @param {string} idToRate The ID of the recipe to rate.
             * @param {string|null} rating The rating ('up', 'down', or null to clear).
             */
            function updateRecipeRating(idToRate, rating) {
                const recipeIndex = pastRecipes.findIndex(recipe => recipe.id === idToRate);
                if (recipeIndex > -1) {
                    pastRecipes[recipeIndex].rating = rating;
                    saveRecipesToLocalStorage();
                    updateRatingButtonStates(rating); // Update UI immediately
                    showMessage(`Recipe rated: ${rating || 'cleared'}.`, 'info');
                }
            }

            /**
             * Updates the visual state of the thumb up/down buttons.
             * @param {string|null} currentRating The current rating of the displayed recipe.
             */
            function updateRatingButtonStates(currentRating) {
                thumbUpBtn.classList.remove('active-thumb-up');
                thumbDownBtn.classList.remove('active-thumb-down');

                if (currentRating === 'up') {
                    thumbUpBtn.classList.add('active-thumb-up');
                } else if (currentRating === 'down') {
                    thumbDownBtn.classList.add('active-thumb-down');
                }
            }

            /**
             * Attempts to share recipe content using the Web Share API,
             * or falls back to copying to clipboard if not supported.
             * @param {string} recipeName The name of the recipe.
             * @param {string} rawRecipeContent The raw HTML content of the recipe.
             */
            async function shareRecipe(recipeName, rawRecipeContent) {
                // Disable action buttons to prevent multiple clicks during operation
                shareCurrentRecipeBtn.disabled = true;
                downloadCurrentRecipeBtn.disabled = true;
                copyCurrentRecipeBtn.disabled = true;

                // Get plain text version of the recipe for sharing
                const plainTextContent = getPlainTextRecipeContent(rawRecipeContent, defaultMeasurementSystem);

                if (navigator.share) { // Check if Web Share API is available
                    try {
                        await navigator.share({
                            title: recipeName,
                            text: `Check out this recipe from Chef AI:\n\n${plainTextContent}`,
                        });
                        showMessage('Recipe shared successfully!', 'success');
                    } catch (error) {
                        // Ignore 'AbortError' which occurs if the user cancels the share dialog
                        if (error.name !== 'AbortError') {
                            console.error('Error sharing recipe:', error);
                            showMessage(`Failed to share recipe: ${error.message}`, 'error');
                        } else {
                            showMessage('Recipe sharing cancelled.', 'info');
                        }
                    }
                } else {
                    // Fallback to copying to clipboard if Web Share API is not supported
                    copyToClipboard(plainTextContent, `Recipe "${recipeName}" content copied to clipboard.`, 'Failed to copy recipe content.');
                }
                // Re-enable buttons after operation completes
                shareCurrentRecipeBtn.disabled = false;
                downloadCurrentRecipeBtn.disabled = false;
                copyCurrentRecipeBtn.disabled = false;
            }

            /**
             * Downloads the recipe content as a plain text (.txt) file.
             * @param {string} recipeName The name of the recipe.
             * @param {string} rawRecipeContent The raw HTML content of the recipe.
             */
            function downloadRecipe(recipeName, rawRecipeContent) { 
                // Disable action buttons during operation
                shareCurrentRecipeBtn.disabled = true;
                downloadCurrentRecipeBtn.disabled = true;
                copyCurrentRecipeBtn.disabled = true;

                // Get plain text version of the recipe for download
                const formattedContent = getPlainTextRecipeContent(rawRecipeContent, defaultMeasurementSystem);

                // Create a Blob and URL for download
                const blob = new Blob([formattedContent], { type: 'text/plain' });
                const url = URL.createObjectURL(blob);

                // Create a temporary anchor element to trigger download
                const a = document.createElement('a');
                a.href = url;
                a.download = `${recipeName.replace(/[^a-z0-9]/gi, '_')}.txt`; // Sanitize filename, set extension to .txt
                document.body.appendChild(a);

                a.click(); // Programmatically click the link to start download

                document.body.removeChild(a); // Clean up the temporary link
                URL.revokeObjectURL(url); // Release the object URL
                showMessage(`Downloading "${recipeName}"...`, 'info');

                // Re-enable buttons
                shareCurrentRecipeBtn.disabled = false;
                downloadCurrentRecipeBtn.disabled = false;
                copyCurrentRecipeBtn.disabled = false;
            }

            /**
             * Copies text content to the clipboard. Uses `document.execCommand('copy')` for broader compatibility in iframes.
             * @param {string} text The text to copy.
             * @param {string} successMessage Message to show on successful copy.
             * @param {string} errorMessage Message to show on failed copy.
             */
            function copyToClipboard(text, successMessage = 'Copied to clipboard!', errorMessage = 'Failed to copy to clipboard.') {
                let textArea = document.createElement("textarea");
                textArea.value = text;
                // Position off-screen and make invisible to avoid visual disruption
                textArea.style.top = "0";
                textArea.style.left = "0";
                textArea.style.position = "fixed";
                textArea.style.opacity = "0"; 

                document.body.appendChild(textArea);
                textArea.focus();
                textArea.select(); // Select the text in the textarea

                try {
                    const successful = document.execCommand('copy'); // Execute copy command
                    if (successful) {
                        showMessage(successMessage, 'success');
                    } else {
                        showMessage(errorMessage, 'error');
                    }
                } catch (err) {
                    console.error('Failed to copy to clipboard:', err);
                    showMessage(errorMessage, 'error');
                } finally {
                    document.body.removeChild(textArea); // Clean up the textarea
                }
            }


            // --- Measurement and Temperature Conversion Logic (Copied from v21.html) ---
            const conversions = {
                // Volume: Imperial to Metric
                'cup': { to: 'ml', rate: 236.588, singular: 'cup', plural: 'cups' },
                'cups': { to: 'ml', rate: 236.588, singular: 'cup', plural: 'cups' },
                'tbsp': { to: 'ml', rate: 14.787, singular: 'tablespoon', plural: 'tablespoons' },
                'tablespoon': { to: 'ml', rate: 14.787, singular: 'tablespoon', plural: 'tablespoons' },
                'tablespoons': { to: 'ml', rate: 14.787, singular: 'tablespoon', plural: 'tablespoons' },
                'tsp': { to: 'ml', rate: 4.929, singular: 'teaspoon', plural: 'teaspoons' },
                'teaspoon': { to: 'ml', rate: 4.929, singular: 'teaspoon', plural: 'teaspoons' },
                'teaspoons': { to: 'ml', rate: 4.929, singular: 'teaspoon', plural: 'teaspoons' },
                'fl oz': { to: 'ml', rate: 29.5735, singular: 'fluid ounce', plural: 'fluid ounces' },
                'fluid ounce': { to: 'ml', rate: 29.5735, singular: 'fluid ounce', plural: 'fluid ounces' },
                'fluid ounces': { to: 'ml', rate: 29.5735, singular: 'fluid ounce', plural: 'fluid ounces' },
                'pint': { to: 'ml', rate: 473.176, singular: 'pint', plural: 'pints' },
                'pints': { to: 'ml', rate: 473.176, singular: 'pint', plural: 'pints' },
                'quart': { to: 'ml', rate: 946.353, singular: 'quart', plural: 'quarts' },
                'quarts': { to: 'ml', rate: 946.353, singular: 'quart', plural: 'quarts' },
                'gallon': { to: 'ml', rate: 3785.41, singular: 'gallon', plural: 'gallons' },
                'gallons': { to: 'ml', rate: 3785.41, singular: 'gallon', plural: 'gallons' },
                // Volume: Metric to Imperial (for reverse conversion)
                'ml': { to: 'cup', rate: 1 / 236.588, singular: 'milliliter', plural: 'milliliters' },
                'milliliter': { to: 'cup', rate: 1 / 236.588, singular: 'milliliter', plural: 'milliliters' },
                'milliliters': { to: 'cup', rate: 1 / 236.588, singular: 'milliliter', plural: 'milliliters' },
                'l': { to: 'cup', rate: 1000 / 236.588, singular: 'liter', plural: 'liters' }, // Convert L to ml first, then ml to cup
                'liter': { to: 'cup', rate: 1000 / 236.588, singular: 'liter', plural: 'liters' },
                'liters': { to: 'cup', rate: 1000 / 236.588, singular: 'liter', plural: 'liters' },

                // Weight: Imperial to Metric
                'oz': { to: 'g', rate: 28.3495, singular: 'ounce', plural: 'ounces' },
                'ounce': { to: 'g', rate: 28.3495, singular: 'ounce', plural: 'ounces' },
                'ounces': { to: 'g', rate: 28.3495, singular: 'ounce', plural: 'ounces' },
                'lb': { to: 'g', rate: 453.592, singular: 'pound', plural: 'pounds' },
                'pound': { to: 'g', rate: 453.592, singular: 'pound', plural: 'pounds' },
                'pounds': { to: 'g', rate: 453.592, singular: 'pound', plural: 'pounds' },
                // Weight: Metric to Imperial (for reverse conversion)
                'g': { to: 'oz', rate: 1 / 28.3495, singular: 'gram', plural: 'grams' },
                'gram': { to: 'oz', rate: 1 / 28.3495, singular: 'gram', plural: 'grams' },
                'grams': { to: 'oz', rate: 1 / 28.3495, singular: 'gram', plural: 'grams' },
                'kg': { to: 'lb', rate: 2.20462, singular: 'kilogram', plural: 'kilograms' },
                'kilogram': { to: 'lb', rate: 2.20462, singular: 'kilogram', plural: 'kilograms' },
                'kilograms': { to: 'lb', rate: 2.20462, singular: 'kilogram', plural: 'kilograms' },
            };

            const imperialUnits = ['cup', 'cups', 'tbsp', 'tablespoon', 'tablespoons', 'tsp', 'teaspoon', 'teaspoons', 'fl oz', 'fluid ounce', 'fluid ounces', 'pint', 'pints', 'quart', 'quarts', 'gallon', 'gallons', 'oz', 'ounce', 'ounces', 'lb', 'pound', 'pounds'];
            const metricUnits = ['ml', 'milliliter', 'milliliters', 'l', 'liter', 'liters', 'g', 'gram', 'grams', 'kg', 'kilogram', 'kilograms'];

            function getUnitSystem(unit) {
                if (imperialUnits.includes(unit.toLowerCase())) {
                    return 'imperial';
                }
                if (metricUnits.includes(unit.toLowerCase())) {
                    return 'metric';
                }
                return null;
            }

            // Function to parse numeric values, including fractions (e.g., "1/2", "1 1/2")
            function parseNumericValue(str) {
                str = str.trim();
                let value = NaN;

                // Handle mixed numbers and pure fractions
                const mixedNumberMatch = str.match(/^(\d+)\s+(\d+)\/(\d+)$/); // e.g., "1 1/2"
                const pureFractionMatch = str.match(/^(\d+)\/(\d+)$/); // e.g., "1/2"

                if (mixedNumberMatch) {
                    value = parseFloat(mixedNumberMatch[1]) + (parseFloat(mixedNumberMatch[2]) / parseFloat(mixedNumberMatch[3]));
                } else if (pureFractionMatch) {
                    value = parseFloat(pureFractionMatch[1]) / parseFloat(pureFractionMatch[2]);
                } else {
                    // Handle decimals and whole numbers
                    value = parseFloat(str);
                }
                return value;
            }

            function convertAllMeasurements(value, unit) {
                const lowerUnit = unit.toLowerCase();
                const sourceSystem = getUnitSystem(lowerUnit);
                let results = {};

                // Add original measurement
                results[`${formatNumber(value)} ${unit}`] = {
                    value: value,
                    unit: unit,
                    system: sourceSystem,
                    isOriginal: true
                };

                if (sourceSystem === 'imperial') {
                    // Try to convert to metric
                    if (conversions[lowerUnit] && conversions[lowerUnit].to) {
                        const convertedValue = value * conversions[lowerUnit].rate;
                        const convertedUnit = conversions[lowerUnit].to;
                        results[`${formatNumber(convertedValue)} ${convertedUnit}`] = {
                            value: convertedValue,
                            unit: convertedUnit,
                            system: 'metric'
                        };
                    }
                } else if (sourceSystem === 'metric') {
                    // Try to convert to imperial
                    // Find suitable imperial conversion (inverse)
                    for (const key in conversions) {
                        if (conversions[key].to === lowerUnit && getUnitSystem(key) === 'imperial') {
                            const convertedValue = value * (1 / conversions[key].rate);
                            const convertedUnit = key;
                            results[`${formatNumber(convertedValue)} ${convertedUnit}`] = {
                                value: convertedValue,
                                unit: convertedUnit,
                                system: 'imperial'
                            };
                            // Also add common imperial alternatives if applicable (e.g., for ml, also show tbsp/tsp)
                            if (lowerUnit === 'ml') {
                                results[`${formatNumber(value / conversions['tbsp'].rate)} tbsp`] = { value: value / conversions['tbsp'].rate, unit: 'tbsp', system: 'imperial' };
                                results[`${formatNumber(value / conversions['tsp'].rate)} tsp`] = { value: value / conversions['tsp'].rate, unit: 'tsp', system: 'imperial' };
                            }
                            break; // Take the first relevant imperial conversion
                        }
                    }
                }
                return results;
            }

            function convertTemperature(value, unit) {
                let results = {};
                // Format for display (round to integer, add degree symbol)
                const formatTemp = (val, u) => `${Math.round(val)}°${u}`;

                if (unit === 'F') {
                    results[formatTemp(value, 'F')] = { value: value, unit: 'F', isOriginal: true };
                    results[formatTemp((value - 32) * 5/9, 'C')] = { value: (value - 32) * 5/9, unit: 'C' };
                } else if (unit === 'C') {
                    results[formatTemp(value, 'C')] = { value: value, unit: 'C', isOriginal: true };
                    results[formatTemp((value * 9/5) + 32, 'F')] = { value: (value * 9/5) + 32, unit: 'F' };
                }
                return results;
            }
            
            function formatNumber(num) {
                // Formats numbers to max 2 decimal places, removes trailing zeros
                if (typeof num !== 'number' || isNaN(num)) return num;
                return parseFloat(num.toFixed(2)).toString();
            }

            // Function to process recipe HTML and wrap measurements for display
            function processRecipeHtml(htmlContent, defaultSystem) {
                const tempDiv = document.createElement('div');
                tempDiv.innerHTML = htmlContent;

                // Measurement Regex: captures number (int/decimal/fraction) and unit
                // Using \b for word boundaries to avoid matching parts of other words
                // Group 1: numeric value part, Group 2: unit part
                const measurementRegex = /\b(\d+(?:\s*\d*\/\d+)?(?:\.\d+)?)\s*(cups?|tablespoons?|tbsp|teaspoons?|tsp|fl\s*oz|fluid\s*ounces?|ml|milliliters?|liters?|l|grams?|g|kilograms?|kg|ounces?|oz|pounds?|lb|pints?|quarts?|gallons?)\b/gi;
                
                // Temperature Regex: captures number and unit (°F, °C, degrees Fahrenheit, degrees Celsius)
                // Group 1: numeric value part, Group 2: unit part
                const temperatureRegex = /\b(\d+(?:\.\d+)?)\s*(°F|°C|degrees?\s*(?:Fahrenheit|Celsius))\b/gi;


                const walk = document.createTreeWalker(tempDiv, NodeFilter.SHOW_TEXT, null, false);
                let node;
                const nodesToProcess = [];

                while ((node = walk.nextNode())) {
                    // Exclude nodes that are already inside a .measurement-unit span
                    if (node.parentNode && node.parentNode.classList && node.parentNode.classList.contains('measurement-unit')) {
                        continue;
                    }
                    nodesToProcess.push(node);
                }

                nodesToProcess.forEach(textNode => {
                    let originalText = textNode.nodeValue;
                    let newHtml = originalText; // Start with original

                    // Process temperatures first to avoid issues with 'degrees' being caught as a unit later
                    newHtml = newHtml.replace(temperatureRegex, (match, valueStr, unit) => {
                        let value = parseFloat(valueStr);
                        if (isNaN(value)) {
                            console.warn(`Failed to parse temperature value: ${valueStr}. Returning original.`);
                            return match;
                        }
                        const unitType = unit.includes('F') || unit.includes('Fahrenheit') ? 'F' : 'C';
                        
                        // Display value in the default system for temperatures
                        let displayValue = value;
                        let displayUnit = unitType;
                        if (defaultSystem === 'imperial' && unitType === 'C') { // Convert C to F for display if default is imperial
                            displayValue = (value * 9/5) + 32;
                            displayUnit = 'F';
                        } else if (defaultSystem === 'metric' && unitType === 'F') { // Convert F to C for display if default is metric
                            displayValue = (value - 32) * 5/9;
                            displayUnit = 'C';
                        }

                        return `<span class="measurement-unit" 
                                    data-value="${value}" 
                                    data-unit="${unitType}"
                                    data-type="temperature">
                                    ${Math.round(displayValue)}°${displayUnit}
                                </span>`;
                    });

                    // Process measurements
                    newHtml = newHtml.replace(measurementRegex, (match, valueStr, unit) => { // Corrected callback arguments
                        let value = parseNumericValue(valueStr);
                        if (isNaN(value)) { // If parsing fails, return original match
                            console.warn(`Failed to parse measurement value: ${valueStr}. Returning original.`);
                            return match;
                        }

                        const currentSystem = getUnitSystem(unit);
                        let displayValue = value;
                        let displayUnit = unit;

                        if (currentSystem && currentSystem !== defaultSystem) {
                            const converted = convertAllMeasurements(value, unit);
                            // Find the display unit based on the default system
                            for (const key in converted) {
                                if (converted[key].system === defaultSystem) {
                                    displayValue = converted[key].value;
                                    displayUnit = converted[key].unit;
                                    break;
                                }
                            }
                        }
                        
                        return `<span class="measurement-unit" 
                                    data-value="${value}" 
                                    data-unit="${unit}"
                                    data-type="measurement">
                                    ${formatNumber(displayValue)} ${displayUnit}
                                </span>`;
                    });

                    // If modifications were made, replace the text node with a document fragment
                    if (newHtml !== originalText) {
                        const fragment = document.createDocumentFragment();
                        const tempElement = document.createElement('div');
                        tempElement.innerHTML = newHtml;
                        while (tempElement.firstChild) {
                            fragment.appendChild(tempElement.firstChild);
                        }
                        textNode.parentNode.replaceChild(fragment, textNode);
                    }
                });

                return tempDiv.innerHTML;
            }


            // Function to generate plain text content for download
            function getPlainTextRecipeContent(rawHtml, defaultSystem) {
                const tempDiv = document.createElement('div');
                tempDiv.innerHTML = rawHtml;

                let plainText = [];

                // Regexes for plain text conversion (same as display, but apply directly)
                const measurementRegexPlain = /\b(\d+(?:\s*\d*\/\d+)?(?:\.\d+)?)\s*(cups?|tablespoons?|tbsp|teaspoons?|tsp|fl\s*oz|fluid\s*ounces?|ml|milliliters?|liters?|l|grams?|g|kilograms?|kg|ounces?|oz|pounds?|lb|pints?|quarts?|gallons?)\b/gi;
                const temperatureRegexPlain = /\b(\d+(?:\.\d+)?)\s*(°F|°C|degrees?\s*(?:Fahrenheit|Celsius))\b/gi;

                // Helper function to recursively process nodes for plain text
                function processNodeForPlainText(node) {
                    if (node.nodeType === Node.TEXT_NODE) {
                        let text = node.nodeValue;
                        // Apply measurement replacements directly for plain text download
                        text = text.replace(measurementRegexPlain, (match, valueStr, unit) => {
                            let value = parseNumericValue(valueStr);
                            if (isNaN(value)) return match;

                            const currentSystem = getUnitSystem(unit);
                            let displayValue = value;
                            let displayUnit = unit;

                            if (currentSystem && currentSystem !== defaultSystem) {
                                const converted = convertAllMeasurements(value, unit);
                                for (const key in converted) {
                                    if (converted[key].system === defaultSystem) {
                                        displayValue = converted[key].value;
                                        displayUnit = converted[key].unit;
                                        break;
                                    }
                                }
                            }
                            return `${formatNumber(displayValue)} ${displayUnit}`;
                        });

                        // Apply temperature replacements directly for plain text download
                        text = text.replace(temperatureRegexPlain, (match, valueStr, unit) => {
                            let value = parseFloat(valueStr);
                            if (isNaN(value)) return match;

                            const unitType = unit.includes('F') || unit.includes('Fahrenheit') ? 'F' : 'C';
                            let displayValue = value;
                            let displayUnit = unitType;

                            if (defaultSystem === 'imperial' && unitType === 'C') { // Convert C to F for display if default is imperial
                                displayValue = (value * 9/5) + 32;
                                displayUnit = 'F';
                            } else if (defaultSystem === 'metric' && unitType === 'F') { // Convert F to C for display if default is metric
                                displayValue = (value - 32) * 5/9;
                                displayUnit = 'C';
                            }
                            return `${Math.round(displayValue)}°${displayUnit}`;
                        });

                        plainText.push(text);

                    } else if (node.nodeType === Node.ELEMENT_NODE) {
                        const tagName = node.tagName.toLowerCase();
                        switch (tagName) {
                            case 'h2':
                                plainText.push(`\n\n## `);
                                for (let child of node.childNodes) {
                                    processNodeForPlainText(child);
                                }
                                plainText.push(`\n`);
                                break;
                            case 'h3':
                                plainText.push(`\n### `);
                                for (let child of node.childNodes) {
                                    processNodeForPlainText(child);
                                }
                                plainText.push(`\n`);
                                break;
                            case 'li':
                                plainText.push(`* `); // Bullet for list item
                                for (let child of node.childNodes) {
                                    processNodeForPlainText(child);
                                }
                                plainText.push(`\n`);
                                break;
                            case 'p':
                                plainText.push(`\n`);
                                for (let child of node.childNodes) {
                                    processNodeForPlainText(child);
                                }
                                plainText.push(`\n`);
                                break;
                            default:
                                for (let child of node.childNodes) {
                                    processNodeForPlainText(child);
                                }
                        }
                    }
                }

                for (let child of tempDiv.childNodes) {
                    processNodeForPlainText(child);
                }

                return plainText.join('').trim();
            }


            /**
             * Renders the list of past recipes in both the desktop and mobile modal views.
             * Filters recipes by the current display mode.
             * Sorts recipes by bookmarked status (bookmarked first) then by timestamp (newest first).
             */
            function renderPastRecipes() {
                // Clear existing lists
                pastCookingRecipesListDesktop.innerHTML = '';
                pastBakingRecipesListDesktop.innerHTML = '';
                pastCookingRecipesListMobile.innerHTML = '';
                pastBakingRecipesListMobile.innerHTML = '';

                // Filter recipes based on the current display mode
                const filteredRecipes = pastRecipes.filter(recipe => recipe.mode === currentDisplayMode);

                // Sort recipes: bookmarked recipes appear first, then by newest first for unbookmarked
                filteredRecipes.sort((a, b) => {
                    if (a.isBookmarked && !b.isBookmarked) return -1; 
                    if (!a.isBookmarked && b.isBookmarked) return 1;  
                    return b.timestamp - a.timestamp;
                });

                // Get the correct list and no-recipe message elements based on the current display mode
                const desktopList = currentDisplayMode === 'cooking' ? pastCookingRecipesListDesktop : pastBakingRecipesListDesktop;
                const desktopNoRecipesMsg = currentDisplayMode === 'cooking' ? noPastCookingRecipesDesktopMessage : pastBakingRecipesListDesktop.querySelector('#noPastBakingRecipesDesktop'); // Ensure correct message element
                const mobileList = currentDisplayMode === 'cooking' ? pastCookingRecipesListMobile : pastBakingRecipesListMobile;
                const mobileNoRecipesMsg = currentDisplayMode === 'cooking' ? noPastCookingRecipesMobileMessage : pastBakingRecipesListMobile.querySelector('#noPastBakingRecipesMobile'); // Ensure correct message element


                // Handle empty state (show "No past recipes" message)
                if (filteredRecipes.length === 0) {
                    desktopList.appendChild(desktopNoRecipesMsg);
                    desktopNoRecipesMsg.classList.remove('hidden');
                    mobileList.appendChild(mobileNoRecipesMsg);
                    mobileNoRecipesMsg.classList.remove('hidden');
                    
                } else {
                    // Hide empty state messages
                    desktopNoRecipesMsg.classList.add('hidden');
                    mobileNoRecipesMsg.classList.add('hidden');

                    // Create and append list items for each recipe to both lists
                    filteredRecipes.forEach((recipe) => {
                        const liDesktop = createRecipeListItem(recipe);
                        desktopList.appendChild(liDesktop);

                        const liMobile = createRecipeListItem(recipe);
                        mobileList.appendChild(liMobile);
                    });
                }
                
                // Show/hide clear all button based on the number of unbookmarked recipes in the current mode
                const unbookmarkedCountInCurrentMode = filteredRecipes.filter(recipe => !recipe.isBookmarked).length;
                if (unbookmarkedCountInCurrentMode > 0) {
                    clearAllRecipesBtnDesktop.classList.remove('hidden');
                    clearAllRecipesBtnMobile.classList.remove('hidden');
                } else {
                    clearAllRecipesBtnDesktop.classList.add('hidden');
                    clearAllRecipesBtnMobile.classList.add('hidden');
                }

                // Manage tab visibility (important for mobile modal)
                if (currentDisplayMode === 'cooking') {
                    pastCookingRecipesListDesktop.classList.remove('hidden');
                    pastBakingRecipesListDesktop.classList.add('hidden');
                    pastCookingRecipesListMobile.classList.remove('hidden');
                    pastBakingRecipesListMobile.classList.add('hidden');
                } else {
                    pastCookingRecipesListDesktop.classList.add('hidden');
                    pastBakingRecipesListDesktop.classList.remove('hidden');
                    pastCookingRecipesListMobile.classList.add('hidden');
                    pastBakingRecipesListMobile.classList.remove('hidden');
                }

                // Update tab button active states
                cookingTabBtnDesktop.classList.toggle('active', currentDisplayMode === 'cooking');
                bakingTabBtnDesktop.classList.toggle('active', currentDisplayMode === 'baking');
                cookingTabBtnMobile.classList.toggle('active', currentDisplayMode === 'cooking');
                bakingTabBtnMobile.classList.toggle('active', currentDisplayMode === 'baking');
            }

            /**
             * Helper function to create a single recipe list item HTML structure.
             * This promotes DRY (Don't Repeat Yourself) principle.
             * @param {Object} recipe The recipe object to display.
             * @returns {HTMLElement} A list item (<li>) element representing the recipe.
             */
            function createRecipeListItem(recipe) {
                const li = document.createElement('li');
                li.className = 'flex items-center justify-between p-3 bg-gray-100 rounded-lg shadow-sm'; // Changed to rounded-lg

                // Added 'min-w-0' to ensure the flex item can shrink and allow truncation
                const recipeInfoDiv = document.createElement('div');
                recipeInfoDiv.className = 'flex items-center flex-grow mr-4 min-w-0';

                // Display bookmark icon if bookmarked
                if (recipe.isBookmarked) {
                    const bookmarkIcon = document.createElement('span');
                    bookmarkIcon.className = 'text-yellow-500 mr-2 flex-shrink-0'; // Added flex-shrink-0 to icon
                    bookmarkIcon.innerHTML = `<svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 v0-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.538 1.118l-2.8-2.034a1 1 0 00-1.176 0l-2.8 2.034c-.783.57-1.838-.197-1.538-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.381-1.81.588-1.81h3.462a1 1 0 00.95-.69l1.07-3.292z"></path></svg>`;
                    recipeInfoDiv.appendChild(bookmarkIcon);
                }

                // Recipe name, truncated if too long
                const recipeNameSpan = document.createElement('span');
                recipeNameSpan.className = 'font-medium text-gray-800 truncate'; 
                recipeNameSpan.textContent = recipe.name;
                recipeInfoDiv.appendChild(recipeNameSpan);

                // Add rating icon if present
                if (recipe.rating === 'up') {
                    const thumbUpIcon = document.createElement('span');
                    thumbUpIcon.className = 'ml-2 text-green-500 text-lg flex-shrink-0';
                    thumbUpIcon.innerHTML = '<i class="fas fa-thumbs-up"></i>';
                    recipeInfoDiv.appendChild(thumbUpIcon);
                } else if (recipe.rating === 'down') {
                    const thumbDownIcon = document.createElement('span');
                    thumbDownIcon.className = 'ml-2 text-red-500 text-lg flex-shrink-0';
                    thumbDownIcon.innerHTML = '<i class="fas fa-thumbs-down"></i>';
                    recipeInfoDiv.appendChild(thumbDownIcon);
                }

                li.appendChild(recipeInfoDiv);

                const actionsDiv = document.createElement('div');
                actionsDiv.className = 'flex items-center space-x-2 flex-shrink-0'; // Added flex-shrink-0 to actionsDiv

                // "View" button to display the recipe in the main area
                const viewButton = document.createElement('button');
                viewButton.className = 'flex-shrink-0 text-gray-500 hover:text-indigo-600 p-1 rounded-full hover:bg-gray-200 transition-colors focus:outline-none focus:ring-2 focus:ring-indigo-300';
                viewButton.innerHTML = `<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path></svg>`;
                viewButton.title = `View ${recipe.name}`;
                viewButton.addEventListener('click', (e) => {
                    e.stopPropagation(); // Prevent parent li click if it had one
                    displayRecipe(recipe); // Show the recipe in the main display
                    pastRecipesFullModal.classList.add('hidden'); // Close mobile modal after viewing
                    window.scrollTo({ top: 0, behavior: 'smooth' }); // Scroll to top of page
                });
                actionsDiv.appendChild(viewButton);

                // Bookmark button for individual recipe item
                const bookmarkButton = document.createElement('button');
                bookmarkButton.className = `flex-shrink-0 text-gray-500 hover:text-blue-700 p-1 rounded-full bookmark-btn transition-colors focus:outline-none focus:ring-2 focus:ring-blue-300`;
                bookmarkButton.innerHTML = `<svg class="w-5 h-5" fill="${recipe.isBookmarked ? 'currentColor' : 'none'}" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 5a2 2 0 012-2h10a2 2 0 012 2v16l-7-3.5L5 21V5z"></path></svg>`;
                bookmarkButton.title = recipe.isBookmarked ? 'Unbookmark Recipe' : 'Bookmark Recipe';
                bookmarkButton.addEventListener('click', (e) => {
                    e.stopPropagation();
                    toggleBookmark(recipe.id);
                });
                actionsDiv.appendChild(bookmarkButton);

                // Share Button for individual recipe item
                const shareButton = document.createElement('button');
                shareButton.className = 'flex-shrink-0 text-gray-500 hover:text-indigo-700 p-1 rounded-full share-btn transition-colors focus:outline-none focus:ring-2 focus:ring-indigo-300';
                shareButton.innerHTML = `<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.684 13.342C8.886 12.938 9 12.482 9 12c0-.478-.114-.933-.316-1.342m0 2.684a3 3 0 110-2.684m0 2.684l6.632 3.316m-6.632-6l6.632-3.316m0 0a3 3 0 105.367-2.684 3 3 0 00-5.367 2.684zm0 9.316a3 3 0 105.367 2.684 3 3 0 00-5.367-2.684z"></path></svg>`;
                shareButton.title = `Share ${recipe.name}`;
                shareButton.addEventListener('click', (e) => {
                    e.stopPropagation();
                    shareRecipe(recipe.name, recipe.content);
                });
                actionsDiv.appendChild(shareButton);

                // Download Button for individual recipe item
                const downloadButton = document.createElement('button');
                downloadButton.className = 'flex-shrink-0 text-gray-500 hover:text-green-700 p-1 rounded-full download-btn transition-colors focus:outline-none focus:ring-2 focus:ring-green-300';
                downloadButton.innerHTML = `<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path></svg>`;
                downloadButton.title = `Download ${recipe.name}`;
                downloadButton.addEventListener('click', (e) => {
                    e.stopPropagation();
                    downloadRecipe(recipe.name, recipe.content);
                });
                actionsDiv.appendChild(downloadButton);

                // Delete button (only for unbookmarked recipes)
                if (!recipe.isBookmarked) {
                    const deleteButton = document.createElement('button');
                    deleteButton.className = 'flex-shrink-0 text-red-500 hover:text-red-700 p-1 rounded-full hover:bg-red-100 transition-colors focus:outline-none focus:ring-2 focus:ring-red-300';
                    deleteButton.innerHTML = `<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>`;
                    deleteButton.title = `Delete ${recipe.name}`;
                    deleteButton.addEventListener('click', (e) => {
                        e.stopPropagation();
                        deleteRecipe(recipe.id);
                    });
                    actionsDiv.appendChild(deleteButton);
                }
                
                li.appendChild(actionsDiv);
                return li;
            }

            /**
             * Displays a given recipe object in the main recipe result area.
             * Updates the UI state, shows action buttons, and sets the current recipe ID.
             * @param {Object} recipe The recipe object to display.
             */
            function displayRecipe(recipe) {
                initialState.classList.add('hidden'); // Hide initial message
                loadingState.classList.add('hidden'); // Hide loading spinner
                // Process HTML to wrap units/temps before displaying
                const processedHtml = processRecipeHtml(recipe.content, defaultMeasurementSystem);
                recipeResult.innerHTML = processedHtml;

                // Add padding-top to recipeResult to prevent overlap with action buttons
                // This padding is applied responsively: more for small screens, less for large.
                recipeResult.classList.add('pt-16', 'sm:pt-20', 'lg:pt-8'); 
                
                recipeActions.classList.remove('hidden'); // Show action buttons
                ratingControls.classList.remove('hidden'); // Show rating buttons
                currentRecipeId = recipe.id; // Set the ID of the newly displayed recipe
                updateBookmarkButtonState(recipe.isBookmarked); // Update bookmark button state
                updateRatingButtonStates(recipe.rating); // Update rating button state
            }


            // --- Initialization: Load settings and past recipes from Local Storage ---
            function loadSettingsAndRecipes() {
                // Load API Key and "Remember Me" preference
                const storedApiKey = localStorage.getItem('geminiApiKey');
                const storedRememberKey = localStorage.getItem('rememberApiKey');
                // Load default measurement system
                const storedMeasurementSystem = localStorage.getItem('defaultMeasurementSystem');
                // Load current display mode for past recipes
                const storedDisplayMode = localStorage.getItem('currentDisplayMode');

                if (storedApiKey) {
                    apiKeyInput.value = storedApiKey;
                    geminiApiKey = storedApiKey;
                }
                rememberApiKeyCheckbox.checked = storedRememberKey === 'true';

                if (storedMeasurementSystem) {
                    defaultMeasurementSystem = storedMeasurementSystem;
                    // Set the correct radio button based on loaded preference
                    if (defaultMeasurementSystem === 'imperial') {
                        measureImperialRadio.checked = true;
                    } else {
                        measureMetricRadio.checked = true;
                    }
                } else {
                    // If no preference is stored, default to imperial and save it
                    measureImperialRadio.checked = true;
                    localStorage.setItem('defaultMeasurementSystem', 'imperial');
                }

                // Set the current display mode for past recipes
                if (storedDisplayMode && (storedDisplayMode === 'cooking' || storedDisplayMode === 'baking')) {
                    currentDisplayMode = storedDisplayMode;
                } else {
                    currentDisplayMode = 'cooking'; // Default
                }
                // Update mode toggle in header
                if (currentDisplayMode === 'cooking') {
                    cookingModeToggle.checked = true;
                } else {
                    bakingModeToggle.checked = true;
                }
                currentGenerationMode = currentDisplayMode; // Ensure generation mode matches display mode on load

                // Load Past Recipes
                const storedRecipes = localStorage.getItem('pastRecipes');
                if (storedRecipes) {
                    try {
                        pastRecipes = JSON.parse(storedRecipes);
                        // Ensure each loaded recipe object has 'id', 'isBookmarked', 'timestamp', 'mode', and 'rating' properties
                        pastRecipes = pastRecipes.map(recipe => ({ 
                            ...recipe, 
                            id: recipe.id || generateUUID(), 
                            isBookmarked: recipe.isBookmarked || false, 
                            timestamp: recipe.timestamp || Date.now(),
                            mode: recipe.mode || 'cooking', // Default to 'cooking' for older recipes
                            rating: recipe.rating || null // Default to null for no rating
                        }));
                        saveRecipesToLocalStorage(); // Save back to localStorage to update any missing properties
                        renderPastRecipes(); // Render the recipes based on the current display mode
                    } catch (e) {
                        console.error("Error parsing past recipes from localStorage:", e);
                        pastRecipes = []; // Reset if data is corrupted
                        saveRecipesToLocalStorage(); // Clear corrupted data
                    }
                } else {
                    renderPastRecipes(); // Render empty state for both lists if no recipes are stored
                }
                updateFormForMode(currentGenerationMode); // Update form fields based on initial mode
                updateGenerateButtonText(); // Set initial text for generate button
            }

            loadSettingsAndRecipes(); // Call on DOMContentLoaded to initialize the app state

            // Ensure the button spinner is hidden on initial page load
            buttonSpinner.classList.add('hidden');
            suggestionsButtonSpinner.classList.add('hidden'); // Also hide the new suggestions spinner


            // --- Event Listeners ---

            // Settings Modal Open/Close/Save
            openSettingsBtn.addEventListener('click', () => {
                settingsModal.classList.remove('hidden'); // Show modal
                apiKeyInput.value = geminiApiKey; // Populate API key input with current value
                // Set radio buttons based on current defaultMeasurementSystem
                if (defaultMeasurementSystem === 'imperial') {
                    measureImperialRadio.checked = true;
                } else {
                    measureMetricRadio.checked = true;
                }
            });

            closeSettingsBtn.addEventListener('click', () => {
                settingsModal.classList.add('hidden'); // Hide modal
            });

            saveSettingsBtn.addEventListener('click', () => {
                geminiApiKey = apiKeyInput.value.trim(); // Get trimmed API key
                const shouldRemember = rememberApiKeyCheckbox.checked;
                const selectedMeasurementSystem = document.querySelector('input[name="defaultMeasurement"]:checked').value;

                // Save/remove API Key from local storage based on "Remember Me" checkbox
                if (geminiApiKey) {
                    if (shouldRemember) {
                        localStorage.setItem('geminiApiKey', geminiApiKey);
                        localStorage.setItem('rememberApiKey', 'true');
                    } else {
                        localStorage.removeItem('geminiApiKey');
                        localStorage.setItem('rememberApiKey', 'false');
                    }
                } else {
                    localStorage.removeItem('geminiApiKey');
                    localStorage.setItem('rememberApiKey', 'false');
                    geminiApiKey = ''; // Clear in-memory key if not remembered
                }

                // Save default measurement system to local storage and update in-memory variable
                localStorage.setItem('defaultMeasurementSystem', selectedMeasurementSystem);
                defaultMeasurementSystem = selectedMeasurementSystem; 
                
                // If a recipe is currently displayed, re-render it to apply the new measurement system
                if (currentRecipeId !== null && recipeResult.innerHTML !== '' && initialState.classList.contains('hidden') && loadingState.classList.contains('hidden')) {
                    const currentRecipe = pastRecipes.find(recipe => recipe.id === currentRecipeId);
                    if (currentRecipe) {
                         recipeResult.innerHTML = processRecipeHtml(currentRecipe.content, defaultMeasurementSystem);
                    }
                }

                showMessage('Settings saved successfully!', 'success');
                settingsModal.classList.add('hidden'); // Hide modal
            });


            // Close modals when clicking outside of them
            window.addEventListener('click', (e) => {
                if (e.target === settingsModal) {
                    settingsModal.classList.add('hidden');
                }
                if (e.target === clearConfirmModal) {
                    clearConfirmModal.classList.add('hidden');
                }
                // Only close mobile past recipes modal if click is directly on the overlay
                if (e.target === pastRecipesFullModal) {
                    pastRecipesFullModal.classList.add('hidden');
                }
                // Also close ingredient suggestions popover if clicking outside
                if (e.target !== getSuggestionsBtn && !ingredientSuggestionsPopover.contains(e.target)) {
                    ingredientSuggestionsPopover.classList.add('hidden');
                }
            });

            // Past Recipes Mobile Modal Open/Close
            openPastRecipesMobileBtn.addEventListener('click', () => {
                pastRecipesFullModal.classList.remove('hidden'); // Show mobile modal
                renderPastRecipes(); // Ensure the list is up-to-date
            });

            closePastRecipesModal.addEventListener('click', () => {
                pastRecipesFullModal.classList.add('hidden'); // Hide mobile modal
            });


            // Clear All Recipes Logic (with confirmation modal)
            // Listeners for both desktop and mobile clear buttons
            clearAllRecipesBtnDesktop.addEventListener('click', () => {
                showClearConfirmation();
            });
            clearAllRecipesBtnMobile.addEventListener('click', () => {
                showClearConfirmation();
            });

            /**
             * Displays the confirmation modal before clearing unbookmarked recipes.
             */
            function showClearConfirmation() {
                // Filter recipes specific to the current display mode
                const recipesInCurrentMode = pastRecipes.filter(recipe => recipe.mode === currentDisplayMode);
                const unbookmarkedCount = recipesInCurrentMode.filter(recipe => !recipe.isBookmarked).length;

                if (unbookmarkedCount === 0) { 
                    showMessage(`No unbookmarked ${currentDisplayMode} recipes to clear.`, 'info');
                    return;
                }

                clearConfirmModal.classList.remove('hidden'); // Show confirmation modal
                clearConfirmTitle.textContent = `Confirm Clear Unbookmarked ${currentDisplayMode === 'cooking' ? 'Cooking' : 'Baking'} Recipes`;
                clearConfirmMessage.textContent = `Are you sure you want to clear ${unbookmarkedCount} unbookmarked ${currentDisplayMode} recipe(s)? Bookmarked recipes will be kept.`;
                confirmClearBtn.textContent = `Clear Unbookmarked ${currentDisplayMode === 'cooking' ? 'Cooking' : 'Baking'}`; 
            }

            // Confirm clearing of unbookmarked recipes
            confirmClearBtn.addEventListener('click', () => {
                const originalPastRecipesCountInMode = pastRecipes.filter(recipe => recipe.mode === currentDisplayMode).length;
                
                // Filter out non-bookmarked recipes ONLY for the current display mode
                pastRecipes = pastRecipes.filter(recipe => 
                    (recipe.mode === currentDisplayMode && recipe.isBookmarked) || // Keep bookmarked in current mode
                    (recipe.mode !== currentDisplayMode) // Keep all recipes from other modes
                ); 
                
                const newPastRecipesCountInMode = pastRecipes.filter(recipe => recipe.mode === currentDisplayMode).length;

                if (newPastRecipesCountInMode < originalPastRecipesCountInMode) {
                    showMessage(`Unbookmarked ${currentDisplayMode} recipes cleared.`, 'success');
                } else {
                    showMessage(`No unbookmarked ${currentDisplayMode} recipes were found to clear.`, 'info');
                }
                
                saveRecipesToLocalStorage(); // Save updated list
                renderPastRecipes(); // Re-render both lists for the current display mode
                clearConfirmModal.classList.add('hidden'); // Hide confirmation modal
            });

            // Cancel clearing recipes
            cancelClearBtn.addEventListener('click', () => {
                clearConfirmModal.classList.add('hidden'); // Hide modal
            });


            // Clear Form Button
            clearFormBtn.addEventListener('click', () => {
                recipeForm.reset(); // Resets all form fields
                // Manually set specific defaults if `form.reset()` doesn't handle them as desired
                document.getElementById('size-single').checked = true;
                document.getElementById('servings').value = 1;
                // Uncheck all dietary restriction checkboxes
                document.querySelectorAll('input[name="diet"]:checked').forEach(checkbox => {
                    checkbox.checked = false;
                });
                onlyTheseIngredientsCheckbox.checked = false; // Uncheck "Only use these ingredients"
                cookingModeToggle.checked = true; // Default generation mode to cooking (header toggle)
                currentGenerationMode = 'cooking'; // Update in-memory state
                updateFormForMode(currentGenerationMode); // Update form fields
                updateGenerateButtonText(); // Update button text after clearing
                showMessage('Form cleared.', 'info');
            });

            // Servings Input Logic (+/- buttons and input validation)
            decreaseServingsBtn.addEventListener('click', () => {
                let currentValue = parseInt(servingsInput.value, 10);
                if (!isNaN(currentValue) && currentValue > 1) {
                    servingsInput.value = currentValue - 1;
                }
            });

            increaseServingsBtn.addEventListener('click', () => {
                let currentValue = parseInt(servingsInput.value, 10);
                if (!isNaN(currentValue)) {
                    servingsInput.value = currentValue + 1;
                } else {
                    servingsInput.value = 1; // Default to 1 if input was empty or invalid
                }
            });

            servingsInput.addEventListener('input', (e) => {
                // Ensure input is a number and minimum is 1
                let value = parseInt(e.target.value, 10);
                if (isNaN(value) || value < 1) {
                    e.target.value = 1;
                } else {
                    e.target.value = value;
                }
            });


            // Click-to-Convert Measurement/Temperature Popover Logic
            let activePopoverTarget = null; // To keep track of which element opened the popover

            function showConversionPopover(element, event) {
                // Hide any currently active popover
                conversionPopover.classList.add('hidden');
                if (activePopoverTarget) {
                    document.removeEventListener('click', hidePopoverOnClickOutside);
                }

                // Set the current element as the active target
                activePopoverTarget = element;

                const value = parseFloat(element.dataset.value);
                const unit = element.dataset.unit;
                const type = element.dataset.type;

                let contentHtml = '<ul>';

                if (type === 'measurement') {
                    const allConversions = convertAllMeasurements(value, unit);
                    for (const key in allConversions) {
                        contentHtml += `<li>${key}</li>`;
                    }
                } else if (type === 'temperature') {
                    const tempConversions = convertTemperature(value, unit);
                    for (const key in tempConversions) {
                        contentHtml += `<li>${key}</li>`;
                    }
                }
                contentHtml += '</ul>';

                popoverContent.innerHTML = contentHtml;

                // Position the popover
                const rect = element.getBoundingClientRect();
                const scrollX = window.scrollX || document.documentElement.scrollLeft;
                const scrollY = window.scrollY || document.documentElement.scrollTop;

                // Calculate position relative to the viewport
                let top = rect.bottom + scrollY + 5; // 5px below the element
                let left = rect.left + scrollX;

                // Adjust if popover goes off screen to the right
                if (left + conversionPopover.offsetWidth > window.innerWidth + scrollX) {
                    left = window.innerWidth + scrollX - conversionPopover.offsetWidth - 10; // 10px from right edge
                }
                // Ensure it doesn't go off screen to the left
                if (left < scrollX) {
                    left = scrollX + 10;
                }

                conversionPopover.style.left = `${left}px`;
                conversionPopover.style.top = `${top}px`;
                conversionPopover.classList.remove('hidden');

                // Hide popover when clicking outside
                setTimeout(() => { // Small delay to avoid immediate close if click initiated it
                    document.addEventListener('click', hidePopoverOnClickOutside);
                }, 50);
            }

            function hidePopoverOnClickOutside(e) {
                // Check if the click was outside the popover and not on the element that opened it
                if (!conversionPopover.contains(e.target) && e.target !== activePopoverTarget &&
                    !activePopoverTarget.contains(e.target)) { // Also check if click was inside the parent of activePopoverTarget
                    conversionPopover.classList.add('hidden');
                    activePopoverTarget = null; // Reset
                    document.removeEventListener('click', hidePopoverOnClickOutside);
                }
            }

            recipeResult.addEventListener('click', (e) => {
                if (e.target.classList.contains('measurement-unit')) {
                    e.stopPropagation(); // Prevent immediate close from document click listener
                    showConversionPopover(e.target, e);
                }
            });

            closePopoverBtn.addEventListener('click', () => {
                conversionPopover.classList.add('hidden');
                activePopoverTarget = null;
                document.removeEventListener('click', hidePopoverOnClickOutside);
            });

            // --- Mode Toggle Event Listeners (in header) ---
            cookingModeToggle.addEventListener('change', () => {
                if (cookingModeToggle.checked) {
                    currentGenerationMode = 'cooking';
                    updateFormForMode('cooking');
                    updateGenerateButtonText(); // Update button text on mode change
                }
            });

            bakingModeToggle.addEventListener('change', () => {
                if (bakingModeToggle.checked) {
                    currentGenerationMode = 'baking';
                    updateFormForMode('baking');
                    updateGenerateButtonText(); // Update button text on mode change
                }
            });

            /**
             * Dynamically updates the form fields based on the selected mode (cooking/baking).
             * @param {string} mode The current generation mode ('cooking' or 'baking').
             */
            function updateFormForMode(mode) {
                // Update Cooking Time / Baking Time dropdown
                if (mode === 'cooking') {
                    cookingTimeLabel.textContent = 'Max Cooking Time';
                    cookingTimeSelect.innerHTML = `
                        <option value="15 minutes">Under 15 minutes</option>
                        <option value="30 minutes" selected>30 minutes</option>
                        <option value="1 hour">1 hour</option>
                        <option value="more than 1 hour">1 hour+</option>
                    `;
                    bakingTypeContainer.classList.add('hidden'); // Hide baking type
                    bakingTypeSelect.value = ""; // Reset baking type selection
                } else if (mode === 'baking') {
                    cookingTimeLabel.textContent = 'Max Baking Time (Prep + Bake)';
                    cookingTimeSelect.innerHTML = `
                        <option value="30 minutes">Under 30 minutes</option>
                        <option value="1 hour" selected>30-60 minutes</option>
                        <option value="2 hours">1-2 hours</option>
                        <option value="more than 2 hours">2 hours+</option>
                    `;
                    bakingTypeContainer.classList.remove('hidden'); // Show baking type
                }
            }


            // --- Past Recipes Tab Event Listeners ---
            function switchPastRecipeTab(mode) {
                currentDisplayMode = mode;
                saveRecipesToLocalStorage(); // Save the preference
                renderPastRecipes(); // Re-render to show correct list
            }

            cookingTabBtnDesktop.addEventListener('click', () => switchPastRecipeTab('cooking'));
            bakingTabBtnDesktop.addEventListener('click', () => switchPastRecipeTab('baking'));
            cookingTabBtnMobile.addEventListener('click', () => switchPastRecipeTab('cooking'));
            bakingTabBtnMobile.addEventListener('click', () => switchPastRecipeTab('baking'));


            // --- Dynamic "Generate Recipe" / "Surprise Me!" Button Logic ---
            function updateGenerateButtonText() {
                const instructionsEmpty = customInstructionsTextarea.value.trim() === '';
                const ingredientsEmpty = ingredientsTextarea.value.trim() === '';

                if (instructionsEmpty && ingredientsEmpty) {
                    buttonText.textContent = 'Surprise Me!';
                } else {
                    buttonText.textContent = 'Generate Recipe';
                }
            }

            customInstructionsTextarea.addEventListener('input', updateGenerateButtonText);
            ingredientsTextarea.addEventListener('input', updateGenerateButtonText);


            // --- Recipe Generation Logic ---
            recipeForm.addEventListener('submit', async (e) => {
                e.preventDefault();

                if (!geminiApiKey) {
                    showMessage('Please set your Gemini API key in the settings first.', 'error');
                    settingsModal.classList.remove('hidden'); // Open settings to prompt user
                    return;
                }

                // 1. Gather form data
                const formData = new FormData(recipeForm);
                const theme = formData.get('theme');
                const ingredients = formData.get('ingredients');
                const cookingTime = formData.get('cookingTime');
                const dishSizeOption = formData.get('dishSizeOption'); 
                const servings = formData.get('servings'); 
                const customInstructions = formData.get('customInstructions');
                const onlyTheseIngredients = onlyTheseIngredientsCheckbox.checked; 
                // Get the selected mode for generation
                const selectedGenerationMode = currentGenerationMode; // Use the global state

                // Get baking type if in baking mode
                const bakingType = selectedGenerationMode === 'baking' ? bakingTypeSelect.value : '';


                const dietCheckboxes = document.querySelectorAll('input[name="diet"]:checked');
                const dietaryNeeds = Array.from(dietCheckboxes).map(cb => cb.value).join(', ');

                // Generate a unique ID for the request to encourage a new recipe
                const uniqueRequestId = `request-${generateUUID()}`;

                // 2. Construct the prompt
                let prompt = `You are an expert chef named "Chef AI". A user needs a recipe.
                Your response MUST be ONLY simple HTML (no markdown code block delimiters like \`\`\`html or \`\`\`), using h2 for the title, h3 for sections like "Ingredients" and "Instructions", and ul/ol for lists.
                The recipe MUST be unique and different from any previously generated recipes for similar inputs.
                
                Here are the user's requirements:
                - Mode: ${selectedGenerationMode} recipe. ${selectedGenerationMode === 'baking' ? 'Focus on precise measurements (preferably by weight), baking techniques, and accurate oven temperatures. Avoid pan-frying or stewing methods.' : 'Focus on general cooking techniques.'}
                ${bakingType ? `- Baking Type: ${bakingType}` : ''}
                ${customInstructions ? `- Custom Instructions: ${customInstructions}` : ''}
                - Cuisine Theme: ${theme}
                - Key Ingredients to use if possible: ${ingredients || 'Any'}
                ${onlyTheseIngredients && ingredients ? `- IMPORTANT: Only use these exact ingredients. Do NOT add any other ingredients.` : ''}
                - Desired Time: Around or under ${cookingTime}
                - General Dish Size: ${dishSizeOption}
                - Exact Number of Servings: ${servings}
                ${dietaryNeeds ? `- Dietary Restrictions: ${dietaryNeeds}` : ''}
                
                <!-- Internal Debugging Info: ${uniqueRequestId} -->
                
                Please generate a creative and delicious recipe that fits these criteria. Give it a unique, appealing name.`;

                // 3. Update UI to loading state
                initialState.classList.add('hidden');
                recipeResult.innerHTML = ''; // Clear previous recipe
                recipeActions.classList.add('hidden'); // Hide action buttons
                ratingControls.classList.add('hidden'); // Hide rating buttons
                // Remove any padding from recipeResult when clearing or showing loading state
                recipeResult.classList.remove('pt-16', 'sm:pt-20', 'lg:pt-8');
                loadingState.classList.remove('hidden');
                generateRecipeBtn.disabled = true; // Disable button
                buttonText.classList.add('hidden'); // Hide text
                buttonSpinner.classList.remove('hidden'); // Show spinner


                // 4. Call the Gemini API
                try {
                    let chatHistory = [{ role: "user", parts: [{ text: prompt }] }];
                    const payload = { contents: chatHistory };
                    // Updated API URL to use gemini-2.0-flash
                    const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${geminiApiKey}`;
                    
                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (!response.ok) {
                        const errorData = await response.json();
                        throw new Error(`API Error: ${errorData.error.message}`);
                    }

                    const result = await response.json();

                    if (result.candidates && result.candidates.length > 0 &&
                        result.candidates[0].content && result.candidates[0].content.parts &&
                        result.candidates[0].content.parts.length > 0) {
                        let recipeHtml = result.candidates[0].content.parts[0].text;
                        
                        // Clean up the recipeHtml: remove markdown code block fences and internal request ID
                        // This pattern looks for an opening ```html followed by optional newline, and a closing ``` followed by optional newline.
                        // It also tries to remove the comment added for internal debugging.
                        recipeHtml = recipeHtml.replace(/^```html\n?/, '').replace(/\n?```$/, '');
                        recipeHtml = recipeHtml.replace(/<!-- Internal Debugging Info: request-[0-9a-f-]+ -->/g, '').trim(); // Use g for global replace

                        // Process the recipe HTML to wrap measurements for conversion
                        const processedHtml = processRecipeHtml(recipeHtml, defaultMeasurementSystem);

                        // Set the recipe content
                        recipeResult.innerHTML = processedHtml;

                        // 5. Save and render past recipe (save raw HTML, then process when rendering from past)
                        const recipeName = extractRecipeName(recipeHtml);
                        // CORRECTED: Define newRecipeObject to capture the generated ID
                        const newRecipeObject = { id: generateUUID(), name: recipeName, content: recipeHtml, isBookmarked: false, timestamp: Date.now(), mode: selectedGenerationMode, rating: null };
                        pastRecipes.push(newRecipeObject);
                        saveRecipesToLocalStorage();
                        // Automatically switch past recipes tab to the newly generated recipe's mode
                        switchPastRecipeTab(selectedGenerationMode); 
                        showMessage('Recipe generated and saved!', 'success');

                        // Update UI after successful generation
                        recipeActions.classList.remove('hidden'); // Show action buttons
                        ratingControls.classList.remove('hidden'); // Show rating buttons
                        currentRecipeId = newRecipeObject.id; // Set the ID of the currently displayed recipe
                        updateBookmarkButtonState(false); // New recipe is not bookmarked by default
                        updateRatingButtonStates(null); // New recipe has no rating by default

                        // Add padding-top to recipeResult to prevent overlap with action buttons
                        // This padding is applied responsively: more for small screens, less for large.
                        recipeResult.classList.add('pt-16', 'sm:pt-20', 'lg:pt-8'); 


                    } else {
                        throw new Error('No content received from API.');
                    }

                } catch (error) {
                    console.error("Error fetching recipe:", error);
                    // Make error message more prominent
                    recipeResult.innerHTML = `<div class="api-error-message">
                        <h3 class="font-bold text-xl mb-2">Oops! Something went wrong.</h3>
                        <p class="text-lg">${error.message}</p>
                        <p class="text-base mt-2">Please check your API key and network connection, then try again.</p>
                        </div>`;
                    showMessage(`Error: ${error.message}`, 'error');
                    // Ensure padding is removed on error state
                    recipeResult.classList.remove('pt-16', 'sm:pt-20', 'lg:pt-8');
                } finally {
                    // 6. Hide loading state
                    loadingState.classList.add('hidden');
                    generateRecipeBtn.disabled = false; // Enable button
                    buttonText.classList.remove('hidden'); // Show text
                    buttonSpinner.classList.add('hidden'); // Hide spinner
                    updateGenerateButtonText(); // Update button text after generation completes
                }
            });

            // --- Ingredient Suggestions Logic ---
            getSuggestionsBtn.addEventListener('click', async () => {
                if (!geminiApiKey) {
                    showMessage('Please set your Gemini API key in the settings first.', 'error');
                    settingsModal.classList.remove('hidden'); // Open settings to prompt user
                    return;
                }

                const currentIngredients = ingredientsTextarea.value.trim();
                if (!currentIngredients) {
                    showMessage('Please enter at least one ingredient to get suggestions.', 'info');
                    return;
                }

                // Show loading state for suggestions button
                getSuggestionsBtn.disabled = true;
                suggestionsButtonText.classList.add('hidden');
                suggestionsButtonSpinner.classList.remove('hidden');
                
                // Hide any previous suggestions
                ingredientSuggestionsPopover.classList.add('hidden');
                suggestionsList.innerHTML = '';
                noSuggestionsMessage.classList.add('hidden');


                const suggestionPrompt = `Given the following primary ingredients: "${currentIngredients}".
                Suggest 5-7 additional, complementary ingredients that would pair well for a ${currentGenerationMode} recipe.
                Provide the suggestions as a comma-separated list, e.g., "Ingredient A, Ingredient B, Ingredient C".
                Do NOT include any extra text, only the comma-separated list of ingredients.`;

                try {
                    let chatHistory = [{ role: "user", parts: [{ text: suggestionPrompt }] }];
                    const payload = { contents: chatHistory };
                    const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${geminiApiKey}`;
                    
                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (!response.ok) {
                        const errorData = await response.json();
                        throw new Error(`API Error: ${errorData.error.message}`);
                    }

                    const result = await response.json();
                    let suggestionsText = '';

                    if (result.candidates && result.candidates.length > 0 &&
                        result.candidates[0].content && result.candidates[0].content.parts &&
                        result.candidates[0].content.parts.length > 0) {
                        suggestionsText = result.candidates[0].content.parts[0].text.trim();
                    }

                    const suggestionsArray = suggestionsText.split(',').map(s => s.trim()).filter(s => s !== '');

                    if (suggestionsArray.length > 0) {
                        suggestionsArray.forEach(suggestion => {
                            const li = document.createElement('li');
                            li.textContent = suggestion;
                            li.addEventListener('click', () => {
                                // Add suggestion to textarea if not already present
                                const currentText = ingredientsTextarea.value.trim();
                                if (!currentText.toLowerCase().includes(suggestion.toLowerCase())) {
                                    ingredientsTextarea.value = currentText ? `${currentText}, ${suggestion}` : suggestion;
                                }
                                ingredientSuggestionsPopover.classList.add('hidden'); // Hide popover after selection
                                showMessage(`Added "${suggestion}" to ingredients.`, 'info');
                                updateGenerateButtonText(); // Update button text after adding ingredients
                            });
                            suggestionsList.appendChild(li);
                        });
                        noSuggestionsMessage.classList.add('hidden');
                    } else {
                        noSuggestionsMessage.classList.remove('hidden');
                    }

                    // Position and show the popover
                    const rect = getSuggestionsBtn.getBoundingClientRect();
                    const scrollX = window.scrollX || document.documentElement.scrollLeft;
                    const scrollY = window.scrollY || document.documentElement.scrollTop;

                    let top = rect.bottom + scrollY + 5;
                    let left = rect.left + scrollX;

                    // Adjust if popover goes off screen to the right
                    if (left + ingredientSuggestionsPopover.offsetWidth > window.innerWidth + scrollX) {
                        left = window.innerWidth + scrollX - ingredientSuggestionsPopover.offsetWidth - 10;
                    }
                    // Ensure it doesn't go off screen to the left
                    if (left < scrollX) {
                        left = scrollX + 10;
                    }

                    ingredientSuggestionsPopover.style.left = `${left}px`;
                    ingredientSuggestionsPopover.style.top = `${top}px`;
                    ingredientSuggestionsPopover.classList.remove('hidden');

                } catch (error) {
                    console.error("Error fetching ingredient suggestions:", error);
                    showMessage(`Error getting suggestions: ${error.message}`, 'error');
                    noSuggestionsMessage.classList.remove('hidden'); // Show no suggestions message on error
                } finally {
                    // Hide loading state for suggestions button
                    getSuggestionsBtn.disabled = false;
                    suggestionsButtonText.classList.remove('hidden');
                    suggestionsButtonSpinner.classList.add('hidden');
                }
            });

            closeSuggestionsPopoverBtn.addEventListener('click', () => {
                ingredientSuggestionsPopover.classList.add('hidden');
            });


            // --- Event Listeners for Current Recipe Action Buttons ---
            // These buttons now correctly retrieve the current recipe data using currentRecipeId
            bookmarkCurrentRecipeBtn.addEventListener('click', () => {
                if (currentRecipeId) {
                    toggleBookmark(currentRecipeId);
                } else {
                    showMessage('No recipe currently displayed to bookmark.', 'info');
                }
            });

            shareCurrentRecipeBtn.addEventListener('click', () => {
                const currentRecipe = pastRecipes.find(recipe => recipe.id === currentRecipeId);
                if (currentRecipe) {
                    shareRecipe(currentRecipe.name, currentRecipe.content);
                } else {
                    showMessage('No recipe currently displayed to share.', 'info');
                }
            });

            downloadCurrentRecipeBtn.addEventListener('click', () => {
                const currentRecipe = pastRecipes.find(recipe => recipe.id === currentRecipeId);
                if (currentRecipe) {
                    downloadRecipe(currentRecipe.name, currentRecipe.content);
                } else {
                    showMessage('No recipe currently displayed to download.', 'info');
                }
            });

            copyCurrentRecipeBtn.addEventListener('click', () => {
                const currentRecipe = pastRecipes.find(recipe => recipe.id === currentRecipeId);
                if (currentRecipe) {
                    copyToClipboard(getPlainTextRecipeContent(currentRecipe.content, defaultMeasurementSystem), `Recipe "${currentRecipe.name}" content copied to clipboard.`, 'Failed to copy recipe content.');
                } else {
                    showMessage('No recipe currently displayed to copy.', 'info');
                }
            });

            // --- Rating Button Event Listeners ---
            thumbUpBtn.addEventListener('click', () => {
                if (!currentRecipeId) {
                    showMessage('No recipe currently displayed to rate.', 'info');
                    return;
                }
                const currentRecipe = pastRecipes.find(recipe => recipe.id === currentRecipeId);
                if (currentRecipe) {
                    if (currentRecipe.rating === 'up') {
                        // If already liked, un-like it
                        updateRecipeRating(currentRecipeId, null);
                    } else {
                        // Otherwise, like it
                        updateRecipeRating(currentRecipeId, 'up');
                    }
                }
            });

            thumbDownBtn.addEventListener('click', () => {
                if (!currentRecipeId) {
                    showMessage('No recipe currently displayed to rate.', 'info');
                    return;
                }
                const currentRecipe = pastRecipes.find(recipe => recipe.id === currentRecipeId);
                if (currentRecipe) {
                    if (currentRecipe.rating === 'down') {
                        // If already disliked, un-dislike it
                        updateRecipeRating(currentRecipeId, null);
                    } else {
                        // Otherwise, dislike it
                        updateRecipeRating(currentRecipeId, 'down');
                    }
                }
            });

        });
    </script>
</body>
</html>
